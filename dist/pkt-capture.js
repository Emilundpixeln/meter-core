"use strict";var E=Object.create;var a=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var I=Object.getPrototypeOf,N=Object.prototype.hasOwnProperty;var q=(i,s)=>{for(var t in s)a(i,t,{get:s[t],enumerable:!0})},v=(i,s,t,e)=>{if(s&&typeof s=="object"||typeof s=="function")for(let r of S(s))!N.call(i,r)&&r!==t&&a(i,r,{get:()=>s[r],enumerable:!(e=P(s,r))||e.enumerable});return i};var w=(i,s,t)=>(t=i!=null?E(I(i)):{},v(s||!i||!i.__esModule?a(t,"default",{value:i,enumerable:!0}):t,i)),L=i=>v(a({},"__esModule",{value:!0}),i);var W={};q(W,{PktCapture:()=>p,PktCaptureAll:()=>k,deviceList:()=>C,findDevice:()=>D});module.exports=L(W);var b=w(require("cap")),T=require("net"),y=require("tiny-typed-emitter");var h=require("stream");var l=class{buffer;position;out;constructor(){this.buffer=null,this.position=0,this.out=[]}write(s){for(;s.length>0;){if(this.buffer){if(this.buffer.length<2){let r=this.buffer[0],f=(s[0]<<8)+r;this.buffer=Buffer.alloc(f),this.buffer[0]=r,this.position=1}let e=Math.min(s.length,this.buffer.length-this.position);s.copy(this.buffer,this.position,0,e),this.position+=e,this.position===this.buffer.length&&(this.out.push(this.buffer),this.buffer=null,this.position=0),s=s.subarray(e);continue}if(s.length<2){this.buffer=Buffer.from(s),this.position=s.length;break}let t=s.readUInt16LE(0);if(t>s.length){this.buffer=Buffer.alloc(t),s.copy(this.buffer),this.position=s.length;break}this.out.push(s.subarray(0,t)),s=s.subarray(t)}}read(){return this.out.shift()}};var d=class extends h.EventEmitter{sessions;listening_port;constructor(s){super(),this.sessions={},this.listening_port=s,h.EventEmitter.call(this)}track_packet(s,t,e){let r=t.info.srcaddr+":"+e.info.srcport,f=t.info.dstaddr+":"+e.info.dstport,o;r<f?o=r+"-"+f:o=f+"-"+r;let c=!1,n=this.sessions[o];n||(c=!0,n=new m(this.listening_port),this.sessions[o]=n,n.on("end",()=>{delete this.sessions[o],console.info(`[meter-core/tcp-tracker] - Remove session ${n?.src}->${n?.dst} (Total: ${Object.keys(this.sessions).length})`)})),n.track(s,t,e),c&&this.emit("session",n)}},m=class extends h.EventEmitter{state;src;dst;send_seqno;send_buffers;recv_seqno;recv_buffers;listening_port;is_ignored;packetBuffer;constructor(s){super(),this.listening_port=s,this.state="NONE",this.send_seqno=0,this.send_buffers=[],this.recv_seqno=0,this.recv_buffers=[],this.is_ignored=!1,this.packetBuffer=new l,h.EventEmitter.call(this)}track(s,t,e){let r=t.info.srcaddr+":"+e.info.srcport,f=t.info.dstaddr+":"+e.info.dstport;this.state==="NONE"?(B(t.info.srcaddr)&&this.listening_port===e.info.dstport?(this.src=r,this.dst=f):this.listening_port===e.info.srcport&&B(t.info.srcaddr)?(this.src=f,this.dst=r):this.is_ignored=!0,e.info.flags&2&&!(e.info.flags&16)?this.state="SYN_SENT":this.state="ESTAB"):e.info.flags&2&&!(e.info.flags&16)||this[this.state](s,t,e)}SYN_SENT(s,t,e){t.info.srcaddr+":"+e.info.srcport===this.dst&&e.info.flags&18?(this.send_seqno=e.info.ackno??0,this.state="SYN_RCVD"):e.info.flags&4&&(this.state="CLOSED")}SYN_RCVD(s,t,e){t.info.srcaddr+":"+e.info.srcport===this.src&&e.info.flags&16&&(this.recv_seqno=e.info.ackno??0,this.state="ESTAB")}ESTAB(s,t,e){if(this.is_ignored)return;let r=t.info.srcaddr+":"+e.info.srcport,f=t.info.totallen-t.hdrlen-e.hdrlen,o=!1;try{o=O(s,t,e)}catch{return}r===this.src?(f>0&&this.send_buffers.push({seqno:e.info.seqno,payload:Buffer.from(s.subarray(e.offset,e.offset+f))}),e.info.ackno&&!o&&this.flush_buffers(e.info.ackno??0,"recv"),e.info.flags&1&&(this.state="FIN_WAIT")):r===this.dst?(f>0&&this.recv_buffers.push({seqno:e.info.seqno,payload:Buffer.from(s.subarray(e.offset,e.offset+f))}),e.info.ackno&&!o&&this.flush_buffers(e.info.ackno??0,"send"),e.info.flags&1&&(this.state="CLOSE_WAIT")):console.error("[meter-core/tcp_tracker] - non-matching packet in session: ip="+t+"tcp="+e)}FIN_WAIT(s,t,e){t.info.srcaddr+":"+e.info.srcport===this.dst&&e.info.flags&1&&(this.state="CLOSING")}CLOSE_WAIT(s,t,e){t.info.srcaddr+":"+e.info.srcport===this.src&&e.info.flags&1&&(this.state="LAST_ACK")}LAST_ACK(s,t,e){t.info.srcaddr+":"+e.info.srcport===this.dst&&(this.state="CLOSED",this.emit("end",this))}CLOSING(s,t,e){t.info.srcaddr+":"+e.info.srcport===this.src&&(this.state="CLOSED",this.emit("end",this))}CLOSED(s,t,e){}flush_buffers(s,t){if(t==="recv"){this.recv_seqno===0&&(this.recv_seqno=s);let e=this.get_flush(this.recv_buffers,this.recv_seqno,s);if(this.recv_seqno=s,!e)return;this.packetBuffer.write(e);let r=this.packetBuffer.read();for(;r;)r=this.packetBuffer.read(),this.emit("payload_recv",r)}else if(t==="send"){this.send_seqno===0&&(this.send_seqno=s);let e=this.get_flush(this.send_buffers,this.send_seqno,s);if(this.send_seqno=s,!e)return}}get_flush(s,t,e){let r=e-t;if(r<=0)return null;let f=Buffer.alloc(r),o=Buffer.alloc(r),c=s.filter(n=>{if(n.seqno>e)return!0;n.seqno<t&&(n.payload=n.payload.subarray(t-n.seqno),n.seqno=t);let _=n.seqno-t,u=e-n.seqno;return n.payload.copy(f,_,0,u),o.fill(1,_,_+u),u<n.payload.length?(n.payload=n.payload.subarray(u),n.seqno+=u,!0):!1});return s.length=0,s.push(...c),o.includes(0)?(console.warn(`[meter-core/tcp_tracker] - Dropped ${r} bytes`),null):f}};function O(i,s,t){if(t.hdrlen==20)return!1;let e=s.offset+s.hdrlen+20,r=t.hdrlen-20,f=e+r;for(;e<f;)switch(i[e]){case 0:e=f;break;case 1:e+=1;break;case 2:e+=4;break;case 3:e+=3;break;case 4:e+=2;break;case 5:return!0;case 8:e+=10;break;case 254:case 255:e+=i[e+1]??1;break;default:throw new Error(`Unknown TCPOption ${i[e]}, packet is probably malformed, should drop.`)}return!1}var A=[/^(::f{4}:)?10\.\d{1,3}\.\d{1,3}\.\d{1,3}/,/^(::f{4}:)?127\.\d{1,3}\.\d{1,3}\.\d{1,3}/,/^(::f{4}:)?169\.254\.([1-9]|1?\d\d|2[0-4]\d|25[0-4])\.\d{1,3}/,/^(::f{4}:)?(172\.1[6-9]|172\.2\d|172\.3[0-1])\.\d{1,3}\.\d{1,3}/,/^(::f{4}:)?192\.168\.\d{1,3}\.\d{1,3}/,/^f[c-d][0-9a-f]{2}(::1$|:[0-9a-f]{1,4}){1,7}/,/^fe[89ab][0-9a-f](::1$|:[0-9a-f]{1,4}){1,7}/];function B(i){return i==="::"||i==="::1"||A.some(function(s){return s.test(i)})}var{findDevice:D,deviceList:C}=b.default.Cap,{Ethernet:$,PROTOCOL:g,IPV4:x,TCP:R}=b.default.decoders;var p=class extends y.TypedEmitter{c;#e;constructor(s){super(),this.c=new b.default.Cap,this.#e=Buffer.alloc(65535);let t=this.c.open(s,"tcp and (src port 6040 or dst port 6040)",10*1024*1024,this.#e),e=new d(6040);this.c.setMinBytes&&this.c.setMinBytes(54),this.c.on("packet",(r,f)=>{if(t==="ETHERNET"){let o=$(this.#e);if(o.info.type===g.ETHERNET.IPV4){let c=x(this.#e,o.offset);if(c.info.protocol===g.IP.TCP){let n=R(this.#e,c.offset);e.track_packet(this.#e,c,n)}}}}),e.on("session",r=>{console.info(`[meter-core/pkt-capture] - New session ${r.src}->${r.dst} (Total: ${Object.keys(e.sessions).length})`),r.on("payload_recv",f=>{this.emit("packet",f)})})}close(){this.c.close()}},k=class extends y.TypedEmitter{caps;constructor(){super(),this.caps=new Map;for(let s of C())for(let t of s.addresses)if((0,T.isIPv4)(t.addr))try{let e=new p(s.name);e.on("packet",r=>this.emit("packet",r,s.name)),this.caps.set(s.name,e)}catch(e){console.error(`[meter-core/PktCaptureAll] ${e}`)}}close(){for(let s of this.caps.values())s.close()}};0&&(module.exports={PktCapture,PktCaptureAll,deviceList,findDevice});
