import{TypedEmitter as a}from"tiny-typed-emitter";import h from"cap";import{isIPv4 as b}from"net";var{findDevice:B,deviceList:m}=h.Cap,{Ethernet:d,PROTOCOL:p,IPV4:k,TCP:g}=h.decoders;var n=class extends a{c;device;constructor(e){super(),this.device=e,this.c=new h.Cap;let s=Buffer.alloc(65535),i=this.c.open(e,"tcp and src port 6040",10*1024*1024,s),r=new c;this.c.setMinBytes&&this.c.setMinBytes(0),this.c.on("packet",()=>{if(i==="ETHERNET"){let t=d(s);if(t.info.type===p.ETHERNET.IPV4&&(t=k(s,t.offset),t.info.protocol===p.IP.TCP)){let o=t.info.totallen-t.hdrlen;if(t=g(s,t.offset),o-=t.hdrlen,o){r.write(Buffer.from(s.subarray(t.offset,t.offset+o)));let f=r.read();for(;f;)this.emit("packet",f),f=r.read()}}}})}close(){try{this.c.close()}catch{}}},l=class extends a{caps;constructor(){super(),this.caps=new Map;for(let e of m())for(let s of e.addresses)if(b(s.addr)){let i;try{i=new n(e.name)}catch(r){console.error(`[meter-core/PktCaptureAll] ${r}`),i?.close();continue}i.on("packet",r=>this.emit("packet",r,e.name)),this.caps.set(e.name,i)}}close(){for(let e of this.caps.values())e.close()}},c=class{buffer;position;out;constructor(){this.buffer=null,this.position=0,this.out=[]}write(e){for(;e.length>0;){if(this.buffer){if(this.buffer.length<2){let r=this.buffer[0],t=(e[0]<<8)+r;this.buffer=Buffer.alloc(t),this.buffer[0]=r,this.position=1}let i=Math.min(e.length,this.buffer.length-this.position);e.copy(this.buffer,this.position,0,i),this.position+=i,this.position===this.buffer.length&&(this.out.push(this.buffer),this.buffer=null,this.position=0),e=e.subarray(i);continue}if(e.length<2){this.buffer=Buffer.from(e),this.position=e.length;break}let s=e.readUInt16LE(0);if(s>e.length)break;this.out.push(e.subarray(0,s)),e=e.subarray(s)}}read(){return this.out.shift()}};export{n as PktCapture,l as PktCaptureAll,m as deviceList,B as findDevice};
