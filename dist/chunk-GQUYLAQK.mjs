import{f as L}from"./chunk-6AGMR5IG.mjs";import{a as E,b as o,c as S,d as v,e as I}from"./chunk-K7C7TUE5.mjs";import{TypedEmitter as M}from"tiny-typed-emitter";var k=class{#r;#a;#t;#e;entities=new Map;localPlayer;constructor(n,t,e,a){this.#r=n,this.#a=t,this.#t=e,this.#e=a,this.localPlayer={entityId:0n,entityType:1,name:"You",class:0,gearLevel:0,characterId:0n,stance:0,stats:new Map,skills:new Map}}processNewPC(n){let t=n.parsed;if(!t)return;let e={entityId:t.pcStruct.playerId,entityType:1,name:t.pcStruct.name,class:t.pcStruct.classId,gearLevel:t.pcStruct.maxItemLevel,characterId:t.pcStruct.characterId,stance:0,stats:this.#e.getStatPairMap(t.pcStruct.statPair),skills:new Map};this.entities.set(e.entityId,e);let a=this.#r.getEntityId(e.characterId);return a&&this.#a.changeEntityId(a,t.pcStruct.playerId),this.#r.addMapping(e.characterId,e.entityId),this.#a.completeEntry(e.characterId,e.entityId),this.#t.newPC(t,this.localPlayer.characterId,n.time),e}processInitEnv(n){let t=n.parsed;if(!t)return;this.localPlayer.entityId!==0n&&this.#a.changeEntityId(this.localPlayer.entityId,t.playerId),this.entities.clear();let e={entityId:t.playerId,entityType:1,name:this.localPlayer.name,class:this.localPlayer.class,gearLevel:this.localPlayer.gearLevel,characterId:this.localPlayer.characterId,stance:this.localPlayer.stance,stats:this.localPlayer.stats,skills:this.localPlayer.skills};this.localPlayer=e,this.entities.set(e.entityId,e),this.#r.clear(),this.#t.Clear(n.time),e.characterId!==0n&&this.#r.addMapping(e.characterId,e.entityId),this.localPlayer&&this.localPlayer.characterId&&this.localPlayer.characterId>0n&&this.#a.completeEntry(this.localPlayer.characterId,t.playerId)}processInitPC(n){let t=n.parsed;if(!t)return;this.entities.clear();let e={entityId:t.playerId,entityType:1,name:t.name,class:t.classId,gearLevel:t.gearLevel,characterId:t.characterId,stance:0,stats:this.#e.getStatPairMap(t.statPair),skills:new Map};this.localPlayer=e,this.entities.set(e.entityId,e),this.#r.addMapping(e.characterId,e.entityId),this.#a.setOwnName(t.name),this.#a.completeEntry(e.characterId,t.playerId),this.#t.RemoveLocalObject(t.playerId,n.time);for(let a of t.statusEffectDatas){let r=this.getSourceEntity(a.sourceId);this.#t.RegisterStatusEffect(this.#t.buildStatusEffect(a,t.playerId,r.entityId,1,n.time))}return e}processNewNpc(n){let t=n.parsed;if(!t)return;let e=!1,a=this.#e.npc.get(t.npcStruct.typeId);a&&[6,7,9,10].includes(L[a.grade])&&(e=!0);let r={entityId:t.npcStruct.objectId,entityType:2,name:a?.name??t.npcStruct.objectId.toString(16),typeId:t.npcStruct.typeId,isBoss:e,grade:a?.grade??"none",pushimmune:a?.pushimmune??!1,stats:this.#e.getStatPairMap(t.npcStruct.statPair),level:t.npcStruct.level,balanceLevel:t.npcStruct.balanceLevel??t.npcStruct.level},s=this.#e.getNpcEsther(t.npcStruct.typeId);s!==void 0&&(r.entityType=4,r.name=s.name,r.icon=s.icon),this.entities.set(r.entityId,r),this.#t.RemoveLocalObject(t.npcStruct.objectId,n.time);for(let i of t.npcStruct.statusEffectDatas){let c=this.getSourceEntity(i.sourceId);this.#t.RegisterStatusEffect(this.#t.buildStatusEffect(i,t.npcStruct.objectId,c.entityId,1,n.time))}return r}processNewNpcSummon(n){let t=n.parsed;if(!t)return;let e=!1,a=this.#e.npc.get(t.npcData.typeId);a&&["boss","raid","epic_raid","commander"].includes(a.grade)&&(e=!0);let r={entityId:t.npcData.objectId,entityType:3,name:a?.name??t.npcData.objectId.toString(16),ownerId:t.ownerId,typeId:t.npcData.typeId,isBoss:e,grade:a?.grade??"none",pushimmune:a?.pushimmune??!1,stats:this.#e.getStatPairMap(t.npcData.statPair),level:t.npcData.level,balanceLevel:t.npcData.balanceLevel??t.npcData.level};this.#t.RemoveLocalObject(t.npcData.objectId,n.time);for(let s of t.npcData.statusEffectDatas){let i=this.getSourceEntity(s.sourceId);this.#t.RegisterStatusEffect(this.#t.buildStatusEffect(s,t.npcData.objectId,i.entityId,1,n.time))}return this.entities.set(r.entityId,r),r}getPlayerSetOptions(n){let t=new Map;n.forEach(a=>{if(a.id&&a.slot&&a.slot>=1&&a.slot<=6){let r=this.#e.itemSet.items.get(a.id);if(r){let s=t.get(r.setname);s||(s=new Map,t.set(r.setname,s)),s.set(r.level,(s.get(r.level)??0)+1)}}});let e=[];return t.forEach((a,r)=>{let s=this.#e.itemSet.seteffects.get(r);if(!s)return;let i=0,c=0;for(let[y,f]of[...a.entries()].sort((u,p)=>p[0]-u[0])){let u=s.get(y);if(!u)return;for(let[p,h]of[...u.entries()])p>i&&f+c>=p&&(e.push(...h.options),i=Math.max(i,p));c=f}}),e}getSourceEntity(n){let t=this.entities.get(n);if((t?.entityType===5||t?.entityType===3)&&(n=t.ownerId),t=this.entities.get(n),t)return t;let e={entityId:n,entityType:2,name:n.toString(16),stats:new Map};return this.entities.set(n,e),e}guessIsPlayer(n,t){let e=this.#e.getSkillClassId(t);if(e!==0){let a;if(n.entityType===1){let r=n;if(r.class===e)return r;a={entityId:r.entityId,entityType:1,name:r.name,class:e,gearLevel:r.gearLevel,characterId:r.characterId,stance:r.stance,stats:r.stats,skills:new Map}}else a={entityId:n.entityId,entityType:1,name:n.name,class:e,gearLevel:0,characterId:0n,stance:0,stats:new Map,skills:new Map};return this.entities.set(n.entityId,a),a}return n}getOrCreateEntity(n){let t=this.entities.get(n);return t||(t={entityId:n,entityType:0,name:n.toString(16),stats:new Map},this.entities.set(n,t)),t}};var d,b,l,P,w,T,R,x=class extends M{constructor(t,e,a=!0,r=!!process.env.DEV){super();S(this,P);S(this,T);E(this,"PartyStatusEffectRegistry");E(this,"LocalStatusEffectRegistry");S(this,d,void 0);S(this,b,void 0);S(this,l,void 0);E(this,"debug");E(this,"trace",!1);this.PartyStatusEffectRegistry=new Map,this.LocalStatusEffectRegistry=new Map,this.debug=r,v(this,d,t),v(this,b,e),v(this,l,a)}getStatusEffectRegistryForPlayer(t,e){let a=this.getPlayerRegistry(e),r=a.get(t);if(r)return r;let s=new Map;return a.set(t,s),s}hasStatusEffectRegistryForPlayer(t,e){return this.getPlayerRegistry(e).has(t)}getPlayerRegistry(t){switch(t){case 1:return this.LocalStatusEffectRegistry;case 0:return this.PartyStatusEffectRegistry;default:break}return this.LocalStatusEffectRegistry}RemoveLocalObject(t,e){let a=this.LocalStatusEffectRegistry.get(t);if(a)for(let[,r]of a)this.RemoveStatusEffect(t,r.instanceId,1,void 0,e);this.LocalStatusEffectRegistry.delete(t)}RemovePartyObject(t,e){let a=this.PartyStatusEffectRegistry.get(t);if(a)for(let[,r]of a)this.RemoveStatusEffect(t,r.instanceId,0,void 0,e);this.PartyStatusEffectRegistry.delete(t)}RegisterStatusEffect(t){let e=this.getStatusEffectRegistryForPlayer(t.targetId,t.type),a=e.get(t.instanceId);a?o(this,l)&&a.expirationTimer&&(clearTimeout(a.expirationTimer),a.expirationTimer=void 0):t.effectType===0&&this.emit("shieldApplied",t),e.set(t.instanceId,t),this.SetupStatusEffectTimeout(t)}HasAnyStatusEffect(t,e,a,r){if(!this.hasStatusEffectRegistryForPlayer(t,e))return!1;let s=this.getStatusEffectRegistryForPlayer(t,e);for(let[,i]of s)if(!(!o(this,l)&&!this.IsReplayStatusEffectValidElseRemove(i,r))){for(let c of a)if(c===i.statusEffectId)return!0}return!1}IsReplayStatusEffectValidElseRemove(t,e){return t.expireAt===void 0||t.expireAt.getTime()>e.getTime()?!0:(this.ExpireStatusEffectByTimeout(t),!1)}HasAnyStatusEffectFromParty(t,e,a,r,s){if(!this.hasStatusEffectRegistryForPlayer(t,e))return!1;let i=this.getStatusEffectRegistryForPlayer(t,e);for(let[,c]of i)if(!(!o(this,l)&&!this.IsReplayStatusEffectValidElseRemove(c,s))&&r.includes(c.statusEffectId)&&(this.ValidForWholeRaid(c)||o(this,d).getPartyIdFromEntityId(c.sourceId)===a))return!0;return!1}RemoveStatusEffect(t,e,a,r,s){if(!this.hasStatusEffectRegistryForPlayer(t,a))return;let i=this.getStatusEffectRegistryForPlayer(t,a),c=i.get(e);c&&(o(this,l)&&(clearTimeout(c.expirationTimer),c.expirationTimer=void 0),i.delete(e),r===4&&(o(this,l)||this.IsReplayStatusEffectValidElseRemove(c,s))&&this.RegisterValueUpdate(c,c.value,0))}GetStatusEffects(t,e,a){if(!this.hasStatusEffectRegistryForPlayer(t,e))return[];let r=this.getStatusEffectRegistryForPlayer(t,e);if(!o(this,l))for(let[,s]of r)this.IsReplayStatusEffectValidElseRemove(s,a);return[...r.values()]}GetStatusEffectsFromParty(t,e,a,r){if(!this.hasStatusEffectRegistryForPlayer(t,e))return[];let s=this.getStatusEffectRegistryForPlayer(t,e);if(!o(this,l))for(let[,i]of s)this.IsReplayStatusEffectValidElseRemove(i,r);return[...s.values()].filter(i=>this.ValidForWholeRaid(i)?!0:a===o(this,d).getPartyIdFromEntityId(i.sourceId))}Clear(t){let e=0;for(let[,r]of this.LocalStatusEffectRegistry){for(let[,s]of r)this.RemoveStatusEffect(s.targetId,s.instanceId,s.type,void 0,t);e+=r.size}let a=0;for(let[,r]of this.PartyStatusEffectRegistry){for(let[,s]of r)this.RemoveStatusEffect(s.targetId,s.instanceId,s.type,void 0,t);a+=r.size}this.trace&&console.log("On Clear SE in local",e,"in party",a),this.LocalStatusEffectRegistry.clear(),this.PartyStatusEffectRegistry.clear()}UpdateDuration(t,e,a,r){let i=this.getStatusEffectRegistryForPlayer(e,r).get(t);if(i){let c=a-i.timestamp;if(o(this,l)&&i.expirationTimer&&(this.trace&&console.log("Clearing timeout for",i.instanceId,"because of duration change"),clearTimeout(i.expirationTimer),i.expirationTimer=void 0),i.expireAt){let y=i.expireAt.getTime()+Number(c),f=y-i.pktTime.getTime();f>0?(this.trace&&console.log("Extending duration by",c,"ms","New timeout delay",f,"from",i.expireAt.toISOString(),"to",new Date(y).toISOString()),o(this,l)&&(i.expirationTimer=setTimeout(this.ExpireStatusEffectByTimeout.bind(this,i),f)),i.expireAt=new Date(y),i.timestamp=a):i.expireAt=void 0}}else this.debug&&console.error("Tried to update duration for SE with instanceId",t," on target",e,"but where is no such SE registered")}SyncStatusEffect(t,e,a,r,s){let i=I(this,T,R).call(this,e,s),c=i?0:1,y=i?e:a;if(!y)return;let u=this.getStatusEffectRegistryForPlayer(y,c).get(t);if(!u)return;let p=u.value;u.value=r,this.RegisterValueUpdate(u,p,r)}ValidForWholeRaid(t){return(t.buffCategory===3||t.buffCategory===1||t.buffCategory===2)&&t.category===1&&t.showType===1}SetupStatusEffectTimeout(t){if(t.expirationDelay>0&&t.expirationDelay<604800){let e=t.pktTime.getTime()>t.occurTime.getTime()?t.pktTime:t.occurTime,a=Math.ceil(t.expirationDelay*1e3),r=e.getTime()+a+x.TIMEOUT_DELAY_MS-t.pktTime.getTime();t.expireAt=new Date(t.pktTime.getTime()+r),this.trace&&console.log("Setting up statuseffect expiration time for",t.name,t.instanceId,"to",t.expireAt.toISOString(),"with delay",r),o(this,l)&&(t.expirationTimer=setTimeout(this.ExpireStatusEffectByTimeout.bind(this,t),r))}}ExpireStatusEffectByTimeout(t){this.debug&&console.error("Triggered timeout on",t.name,"with iid",t.instanceId),this.RemoveStatusEffect(t.targetId,t.instanceId,t.type,void 0,new Date)}RegisterValueUpdate(t,e,a){t.effectType===0&&this.emit("shieldChanged",t,e,a)}newPC(t,e,a){let r=I(this,T,R).call(this,t.pcStruct.characterId,e);r?this.RemovePartyObject(t.pcStruct.characterId,a):this.RemoveLocalObject(t.pcStruct.playerId,a);for(let s of t.pcStruct.statusEffectDatas)this.RegisterStatusEffect(this.buildStatusEffect(s,r?t.pcStruct.characterId:t.pcStruct.playerId,s.sourceId,r?0:1,a))}buildStatusEffect(t,e,a,r,s){let i=t.value?t.value.readUInt32LE():0,c=t.value?t.value.readUInt32LE(8):0,y=i<c?i:c,f=0,u=0,p=0,h="Unknown",g=1,m=o(this,b).skillBuff.get(t.statusEffectId);if(m){switch(h=m.name,m.category){case"debuff":f=1;break}switch(m.buffcategory){case"bracelet":u=1;break;case"etc":u=2;break;case"battleitem":u=3;break}switch(m.iconshowtype){case"all":p=1;break}switch(m.type){case"shield":g=0;break}}return{instanceId:t.effectInstanceId,sourceId:a,statusEffectId:t.statusEffectId,targetId:e,type:r,dbTarget:m?.target??"none",value:y,buffCategory:u,category:f,showType:p,expirationDelay:t.totalTime,expirationTimer:void 0,timestamp:t.endTick,expireAt:void 0,occurTime:t.occurTime,name:h,pktTime:s,effectType:g,stackCount:t.stackCount}}getStatusEffects(t,e,a,r){let s=[],i=[],c=I(this,P,w).call(this,t,a),y=this.GetStatusEffects(c?t.characterId:t.entityId,c?0:1,r);for(let f of y)i.push([f.statusEffectId,f.sourceId,f.stackCount]);if(e){let f=I(this,P,w).call(this,e,a),u=o(this,d).isEntityInParty(t.entityId),p=u?o(this,d).getPartyIdFromEntityId(t.entityId):void 0,h=u&&p?this.GetStatusEffectsFromParty(f?e.characterId:e.entityId,f?0:1,p,r):this.GetStatusEffects(f?e.characterId:e.entityId,f?0:1,r);for(let g of h)g.type===1&&g.category===1&&g.sourceId!==t.entityId&&g.dbTarget==="self"||s.push([g.statusEffectId,g.sourceId,g.stackCount])}return[i,s]}},D=x;d=new WeakMap,b=new WeakMap,l=new WeakMap,P=new WeakSet,w=function(t,e){if(t.entityType!==1)return!1;let a=t;return I(this,T,R).call(this,a.characterId,e)},T=new WeakSet,R=function(t,e){let a=o(this,d).isCharacterInParty(e),r=o(this,d).isCharacterInParty(t);if(a){if(!r||t===e)return!1;let s=o(this,d).getPartyIdFromCharacterId(e),i=o(this,d).getPartyIdFromCharacterId(t);return s===i}return!1},E(D,"TIMEOUT_DELAY_MS",1e3);export{D as a,k as b};
