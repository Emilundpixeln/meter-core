var an=Object.defineProperty;var xn=Object.getOwnPropertyDescriptor;var Rn=Object.getOwnPropertyNames;var Bn=Object.prototype.hasOwnProperty;var Mn=(f,r,_)=>r in f?an(f,r,{enumerable:!0,configurable:!0,writable:!0,value:_}):f[r]=_;var On=(f,r)=>{for(var _ in r)an(f,_,{get:r[_],enumerable:!0})},Cn=(f,r,_,s)=>{if(r&&typeof r=="object"||typeof r=="function")for(let n of Rn(r))!Bn.call(f,n)&&n!==_&&an(f,n,{get:()=>r[n],enumerable:!(s=xn(r,n))||s.enumerable});return f};var Nn=f=>Cn(an({},"__esModule",{value:!0}),f);var V=(f,r,_)=>(Mn(f,typeof r!="symbol"?r+"":r,_),_),cn=(f,r,_)=>{if(!r.has(f))throw TypeError("Cannot "+_)};var R=(f,r,_)=>(cn(f,r,"read from private field"),_?_.call(f):r.get(f)),W=(f,r,_)=>{if(r.has(f))throw TypeError("Cannot add the same private member more than once");r instanceof WeakSet?r.add(f):r.set(f,_)},en=(f,r,_,s)=>(cn(f,r,"write to private field"),s?s.call(f,_):r.set(f,_),_);var z=(f,r,_)=>(cn(f,r,"access private method"),_);var jn={};On(jn,{Parser:()=>Sn});module.exports=Nn(jn);var kn=require("tiny-typed-emitter");var H=(u=>(u[u.none=0]="none",u[u.slot=1]="slot",u[u.stat=2]="stat",u[u.ability_point=3]="ability_point",u[u.combat_effect=4]="combat_effect",u[u.skill_damage=5]="skill_damage",u[u.skill_critical_ratio=6]="skill_critical_ratio",u[u.skill_critical_damage=7]="skill_critical_damage",u[u.skill_penetration=8]="skill_penetration",u[u.npc_grade_less_damage=9]="npc_grade_less_damage",u[u.npc_grade_less_critical_ratio=10]="npc_grade_less_critical_ratio",u[u.npc_grade_less_critical_damage=11]="npc_grade_less_critical_damage",u[u.npc_grade_less_penetration=12]="npc_grade_less_penetration",u[u.npc_grade_greater_damage=13]="npc_grade_greater_damage",u[u.npc_grade_greater_critical_ratio=14]="npc_grade_greater_critical_ratio",u[u.npc_grade_greater_critical_damage=15]="npc_grade_greater_critical_damage",u[u.npc_grade_greater_penetration=16]="npc_grade_greater_penetration",u[u.npc_species_damage=17]="npc_species_damage",u[u.npc_species_critical_ratio=18]="npc_species_critical_ratio",u[u.npc_species_critical_damage=19]="npc_species_critical_damage",u[u.npc_species_penetration=20]="npc_species_penetration",u[u.npc_attr_damage=21]="npc_attr_damage",u[u.npc_attr_critical_ratio=22]="npc_attr_critical_ratio",u[u.npc_attr_critical_damage=23]="npc_attr_critical_damage",u[u.npc_attr_penetration=24]="npc_attr_penetration",u[u.mana_reduction=25]="mana_reduction",u[u.skill_mana_reduction=26]="skill_mana_reduction",u[u.skill_cooldown_reduction=27]="skill_cooldown_reduction",u[u.ability_feature=28]="ability_feature",u[u.class_option=29]="class_option",u[u.ability_point_passive=30]="ability_point_passive",u[u.instrument=31]="instrument",u[u.skill_feature=32]="skill_feature",u[u.npc_adaptation=33]="npc_adaptation",u[u.skill_group_damage=34]="skill_group_damage",u[u.skill_group_cooldown_reduction=35]="skill_group_cooldown_reduction",u[u.skill_level=36]="skill_level",u[u.skill_feature_level=37]="skill_feature_level",u[u.life_casting_speed=38]="life_casting_speed",u[u.life_casting_tier=39]="life_casting_tier",u[u.life_bonus_type_success=40]="life_bonus_type_success",u[u.life_bonus_type_extra=41]="life_bonus_type_extra",u[u.life_bonus_type_skill_bonus=42]="life_bonus_type_skill_bonus",u[u.life_bonus_type_minigame_perfect=43]="life_bonus_type_minigame_perfect",u[u.life_durability_bonus=44]="life_durability_bonus",u[u.life_mini_game_difficulty=45]="life_mini_game_difficulty",u[u.combat_effect_cooldown_reduction=46]="combat_effect_cooldown_reduction",u[u.skill_damage_addend=47]="skill_damage_addend",u[u.awakening_usable_count_addend=48]="awakening_usable_count_addend",u[u.battle_item_heal=49]="battle_item_heal",u[u.party_heal=50]="party_heal",u[u.party_shield=51]="party_shield",u[u.identity_gauge=52]="identity_gauge",u[u.attack_power_amplify_addend=53]="attack_power_amplify_addend",u[u.attack_power_amplify_multiplier=54]="attack_power_amplify_multiplier",u[u.not_in_party_damage=55]="not_in_party_damage",u[u.skill_effect_group_set_damage=56]="skill_effect_group_set_damage",u))(H||{});var sn=(t=>(t[t.none=0]="none",t[t.modify_damage=1]="modify_damage",t[t.modify_final_damage=2]="modify_final_damage",t[t.modify_critical_ratio=3]="modify_critical_ratio",t[t.modify_critical_multiplier=4]="modify_critical_multiplier",t[t.modify_penetration=5]="modify_penetration",t[t.modify_penetration_when_critical=6]="modify_penetration_when_critical",t[t.exec_active_effect_when_damage=7]="exec_active_effect_when_damage",t[t.exec_active_effect_when_critical=8]="exec_active_effect_when_critical",t[t.exec_reactive_effect_when_miss=9]="exec_reactive_effect_when_miss",t[t.exec_reactive_effect_when_damage=10]="exec_reactive_effect_when_damage",t[t.exec_reactive_effect_when_critical=11]="exec_reactive_effect_when_critical",t[t.exec_after_effect=12]="exec_after_effect",t[t.exec_after_skill=13]="exec_after_skill",t[t.apply_heal=14]="apply_heal",t[t.modify_reactive_damage=15]="modify_reactive_damage",t[t.modify_damage_shield_multiplier=16]="modify_damage_shield_multiplier",t[t.exec_active_effect_when_kill=17]="exec_active_effect_when_kill",t[t.exec_start_skill=18]="exec_start_skill",t[t.modify_penetration_addend=19]="modify_penetration_addend",t[t.modify_penetration_addend_when_critical=20]="modify_penetration_addend_when_critical",t[t.modify_reactive_critical_multiplier=21]="modify_reactive_critical_multiplier",t[t.modify_damage_when_critical=22]="modify_damage_when_critical",t[t.modify_paralyzation_point=23]="modify_paralyzation_point",t))(sn||{});var tn=(c=>(c[c.none=0]="none",c[c.underling=1]="underling",c[c.normal=2]="normal",c[c.elite=3]="elite",c[c.named=4]="named",c[c.seed=5]="seed",c[c.boss=6]="boss",c[c.raid=7]="raid",c[c.lucky=8]="lucky",c[c.epic_raid=9]="epic_raid",c[c.commander=10]="commander",c))(tn||{});var rn=(_=>(_[_.absolute=0]="absolute",_[_.relative=1]="relative",_))(rn||{});var ln=(i=>(i[i.none=0]="none",i[i.enable_notify=1]="enable_notify",i[i.enable_dir_change=2]="enable_dir_change",i[i.change_move_dist=3]="change_move_dist",i[i.change_layer=4]="change_layer",i[i.change_stage_speed=5]="change_stage_speed",i[i.change_stage_collision=6]="change_stage_collision",i[i.change_max_target=7]="change_max_target",i[i.change_area_range=8]="change_area_range",i[i.change_area_angle=9]="change_area_angle",i[i.change_cost=10]="change_cost",i[i.recover_cost=11]="recover_cost",i[i.recover_used_cost=12]="recover_used_cost",i[i.reduce_default_cooldown=13]="reduce_default_cooldown",i[i.reduce_active_cooldown=14]="reduce_active_cooldown",i[i.enable_stage_buff=15]="enable_stage_buff",i[i.add_stage_buff=16]="add_stage_buff",i[i.change_buff_area_range=17]="change_buff_area_range",i[i.change_buff_duration=18]="change_buff_duration",i[i.change_buff_stat=19]="change_buff_stat",i[i.change_buff_stack=20]="change_buff_stack",i[i.change_buff_param=21]="change_buff_param",i[i.change_buff_expired_action=22]="change_buff_expired_action",i[i.change_chain_ratio=23]="change_chain_ratio",i[i.change_abnormal=24]="change_abnormal",i[i.change_abnormal_ratio=25]="change_abnormal_ratio",i[i.change_dam_attr=26]="change_dam_attr",i[i.change_dam_value=27]="change_dam_value",i[i.change_dam_coefficient=28]="change_dam_coefficient",i[i.change_dam_critical=29]="change_dam_critical",i[i.change_dam_critical_rate=30]="change_dam_critical_rate",i[i.change_attack_stage_speed=31]="change_attack_stage_speed",i[i.change_stack_charge_time=32]="change_stack_charge_time",i[i.change_stack_max_count=33]="change_stack_max_count",i[i.change_targeting=34]="change_targeting",i[i.change_min_range=35]="change_min_range",i[i.change_max_range=36]="change_max_range",i[i.change_push_info=37]="change_push_info",i[i.change_parts_attack_attr=38]="change_parts_attack_attr",i[i.change_skill_chain_info=39]="change_skill_chain_info",i[i.change_skill_chain_delay=40]="change_skill_chain_delay",i[i.change_behit_move_info=41]="change_behit_move_info",i[i.add_buff_stat=42]="add_buff_stat",i[i.add_chain_skill_effect=43]="add_chain_skill_effect",i[i.remove_chain_skill_effect=44]="remove_chain_skill_effect",i[i.add_chain_combat_effect=45]="add_chain_combat_effect",i[i.remove_chain_combat_effect=46]="remove_chain_combat_effect",i[i.change_skill_effect_bonus=47]="change_skill_effect_bonus",i[i.change_skill_effect_ai_point=48]="change_skill_effect_ai_point",i[i.change_dam_addend=49]="change_dam_addend",i[i.change_hitted=50]="change_hitted",i[i.change_skill_move_speed=51]="change_skill_move_speed",i[i.add_skill_buff=52]="add_skill_buff",i[i.change_skill_bonus=53]="change_skill_bonus",i[i.change_skill_normal_info=54]="change_skill_normal_info",i[i.change_skill_invisibility=55]="change_skill_invisibility",i[i.change_skill_constraint=56]="change_skill_constraint",i[i.change_skill_book_type=57]="change_skill_book_type",i[i.change_projection_skill_effect_id=58]="change_projection_skill_effect_id",i[i.change_push_pvp_info=59]="change_push_pvp_info",i[i.change_forced_critical=60]="change_forced_critical",i[i.change_instance_skill_effect_info=61]="change_instance_skill_effect_info",i[i.change_skill_start_stage=62]="change_skill_start_stage",i[i.change_skill_effect_dir_target=63]="change_skill_effect_dir_target",i[i.change_stage_dir_rate=64]="change_stage_dir_rate",i[i.change_projection=65]="change_projection",i[i.change_skill_view=66]="change_skill_view",i[i.change_projectile_speed=67]="change_projectile_speed",i[i.change_projectile_dist=68]="change_projectile_dist",i[i.change_projectile_resourcescale=69]="change_projectile_resourcescale",i[i.change_projectile_max_target_hit_count=70]="change_projectile_max_target_hit_count",i[i.change_summon_trap_lifetime=71]="change_summon_trap_lifetime",i[i.change_summon_trap_destroy_delaytime=72]="change_summon_trap_destroy_delaytime",i[i.change_summon_trap_react_info=73]="change_summon_trap_react_info",i[i.change_summon_trap_invoke_effect=74]="change_summon_trap_invoke_effect",i[i.change_summon_trap_count=75]="change_summon_trap_count",i[i.enable_identity_event=76]="enable_identity_event",i[i.change_identity_proc_value=77]="change_identity_proc_value",i[i.change_skill_effect_identity_proc_info=78]="change_skill_effect_identity_proc_info",i[i.change_identity_proc_pvp_value=79]="change_identity_proc_pvp_value",i[i.change_skill_effect_identity_proc_pvp_info=80]="change_skill_effect_identity_proc_pvp_info",i[i.change_skill_effect_identity_proc_replace_info=81]="change_skill_effect_identity_proc_replace_info",i[i.change_skill_effect_identity_proc_replace_pvp_info=82]="change_skill_effect_identity_proc_replace_pvp_info",i[i.swap_chain_skill_effect=83]="swap_chain_skill_effect",i[i.swap_chain_combat_effect=84]="swap_chain_combat_effect",i[i.change_charge_scale=85]="change_charge_scale",i[i.change_summon_npc_id=86]="change_summon_npc_id",i[i.change_summon_npc_sight_range=87]="change_summon_npc_sight_range",i[i.change_summon_npc_pursuit_range=88]="change_summon_npc_pursuit_range",i[i.change_summon_npc_walk_movespeed=89]="change_summon_npc_walk_movespeed",i[i.change_summon_npc_battle_movespeed=90]="change_summon_npc_battle_movespeed",i[i.change_summon_npc_life_time=91]="change_summon_npc_life_time",i[i.change_summon_npc_ai_index=92]="change_summon_npc_ai_index",i[i.change_summon_npc_invincible_duration=93]="change_summon_npc_invincible_duration",i[i.change_summon_npc_acquire_identity=94]="change_summon_npc_acquire_identity",i[i.change_summon_npc_skill_id=95]="change_summon_npc_skill_id",i[i.change_summon_npc_die_skill_id=96]="change_summon_npc_die_skill_id",i[i.change_summon_npc_destroy_skill_id=97]="change_summon_npc_destroy_skill_id",i[i.change_summon_npc_spawn_buff_id=98]="change_summon_npc_spawn_buff_id",i[i.change_summon_npc_count=99]="change_summon_npc_count",i[i.change_summon_npc_stat=100]="change_summon_npc_stat",i[i.change_summon_npc_threat_point=101]="change_summon_npc_threat_point",i[i.change_summon_npc_skill_usable_tick=102]="change_summon_npc_skill_usable_tick",i[i.change_summon_npc_skill_use_order=103]="change_summon_npc_skill_use_order",i[i.change_combat_effect_arg=104]="change_combat_effect_arg",i[i.change_skill_effect_cost=105]="change_skill_effect_cost",i[i.change_accumulate_dam_rate=106]="change_accumulate_dam_rate",i[i.change_projectile_bank_data_addend=107]="change_projectile_bank_data_addend",i[i.change_identity_category=108]="change_identity_category",i))(ln||{}),Y=(e=>(e[e.none=0]="none",e[e.hp=1]="hp",e[e.mp=2]="mp",e[e.str=3]="str",e[e.agi=4]="agi",e[e.int=5]="int",e[e.con=6]="con",e[e.str_x=7]="str_x",e[e.agi_x=8]="agi_x",e[e.int_x=9]="int_x",e[e.con_x=10]="con_x",e[e.criticalhit=15]="criticalhit",e[e.specialty=16]="specialty",e[e.oppression=17]="oppression",e[e.rapidity=18]="rapidity",e[e.endurance=19]="endurance",e[e.mastery=20]="mastery",e[e.criticalhit_x=21]="criticalhit_x",e[e.specialty_x=22]="specialty_x",e[e.oppression_x=23]="oppression_x",e[e.rapidity_x=24]="rapidity_x",e[e.endurance_x=25]="endurance_x",e[e.mastery_x=26]="mastery_x",e[e.max_hp=27]="max_hp",e[e.max_mp=28]="max_mp",e[e.max_hp_x=29]="max_hp_x",e[e.max_mp_x=30]="max_mp_x",e[e.max_hp_x_x=31]="max_hp_x_x",e[e.max_mp_x_x=32]="max_mp_x_x",e[e.normal_hp_recovery=33]="normal_hp_recovery",e[e.combat_hp_recovery=34]="combat_hp_recovery",e[e.normal_hp_recovery_rate=35]="normal_hp_recovery_rate",e[e.combat_hp_recovery_rate=36]="combat_hp_recovery_rate",e[e.normal_mp_recovery=37]="normal_mp_recovery",e[e.combat_mp_recovery=38]="combat_mp_recovery",e[e.normal_mp_recovery_rate=39]="normal_mp_recovery_rate",e[e.combat_mp_recovery_rate=40]="combat_mp_recovery_rate",e[e.self_recovery_rate=41]="self_recovery_rate",e[e.drain_hp_dam_rate=42]="drain_hp_dam_rate",e[e.drain_mp_dam_rate=43]="drain_mp_dam_rate",e[e.dam_reflection_rate=44]="dam_reflection_rate",e[e.char_attack_dam=47]="char_attack_dam",e[e.skill_effect_dam_addend=48]="skill_effect_dam_addend",e[e.attack_power_rate=49]="attack_power_rate",e[e.skill_damage_rate=50]="skill_damage_rate",e[e.attack_power_rate_x=51]="attack_power_rate_x",e[e.skill_damage_rate_x=52]="skill_damage_rate_x",e[e.cooldown_reduction=53]="cooldown_reduction",e[e.paralyzation_point_rate=54]="paralyzation_point_rate",e[e.def=55]="def",e[e.res=56]="res",e[e.def_x=57]="def_x",e[e.res_x=58]="res_x",e[e.def_x_x=59]="def_x_x",e[e.res_x_x=60]="res_x_x",e[e.def_pen_rate=67]="def_pen_rate",e[e.res_pen_rate=68]="res_pen_rate",e[e.physical_inc_rate=69]="physical_inc_rate",e[e.magical_inc_rate=70]="magical_inc_rate",e[e.self_shield_rate=71]="self_shield_rate",e[e.hit_rate=72]="hit_rate",e[e.dodge_rate=73]="dodge_rate",e[e.critical_hit_rate=74]="critical_hit_rate",e[e.critical_res_rate=75]="critical_res_rate",e[e.critical_dam_rate=76]="critical_dam_rate",e[e.attack_speed=77]="attack_speed",e[e.attack_speed_rate=78]="attack_speed_rate",e[e.move_speed=79]="move_speed",e[e.move_speed_rate=80]="move_speed_rate",e[e.prop_move_speed=81]="prop_move_speed",e[e.prop_move_speed_rate=82]="prop_move_speed_rate",e[e.vehicle_move_speed=83]="vehicle_move_speed",e[e.vehicle_move_speed_rate=84]="vehicle_move_speed_rate",e[e.ship_move_speed=85]="ship_move_speed",e[e.ship_move_speed_rate=86]="ship_move_speed_rate",e[e.fire_dam_rate=87]="fire_dam_rate",e[e.ice_dam_rate=88]="ice_dam_rate",e[e.electricity_dam_rate=89]="electricity_dam_rate",e[e.earth_dam_rate=91]="earth_dam_rate",e[e.dark_dam_rate=92]="dark_dam_rate",e[e.holy_dam_rate=93]="holy_dam_rate",e[e.elements_dam_rate=94]="elements_dam_rate",e[e.fire_res_rate=95]="fire_res_rate",e[e.ice_res_rate=96]="ice_res_rate",e[e.electricity_res_rate=97]="electricity_res_rate",e[e.earth_res_rate=99]="earth_res_rate",e[e.dark_res_rate=100]="dark_res_rate",e[e.holy_res_rate=101]="holy_res_rate",e[e.elements_res_rate=102]="elements_res_rate",e[e.self_cc_time_rate=105]="self_cc_time_rate",e[e.enemy_cc_time_rate=106]="enemy_cc_time_rate",e[e.identity_value1=107]="identity_value1",e[e.identity_value2=108]="identity_value2",e[e.identity_value3=109]="identity_value3",e[e.awakening_dam_rate=110]="awakening_dam_rate",e[e.item_drop_rate=111]="item_drop_rate",e[e.gold_rate=112]="gold_rate",e[e.exp_rate=113]="exp_rate",e[e.attack_power_addend=123]="attack_power_addend",e[e.attack_power_addend_2=124]="attack_power_addend_2",e[e.npc_species_humanoid_dam_rate=125]="npc_species_humanoid_dam_rate",e[e.npc_species_devil_dam_rate=126]="npc_species_devil_dam_rate",e[e.npc_species_substance_dam_rate=127]="npc_species_substance_dam_rate",e[e.npc_species_undead_dam_rate=128]="npc_species_undead_dam_rate",e[e.npc_species_plant_dam_rate=129]="npc_species_plant_dam_rate",e[e.npc_species_insect_dam_rate=130]="npc_species_insect_dam_rate",e[e.npc_species_spirit_dam_rate=131]="npc_species_spirit_dam_rate",e[e.npc_species_wild_beast_dam_rate=132]="npc_species_wild_beast_dam_rate",e[e.npc_species_mechanic_dam_rate=133]="npc_species_mechanic_dam_rate",e[e.npc_species_ancient_dam_rate=134]="npc_species_ancient_dam_rate",e[e.npc_species_god_dam_rate=135]="npc_species_god_dam_rate",e[e.npc_species_archfiend_dam_rate=136]="npc_species_archfiend_dam_rate",e[e.vitality=137]="vitality",e[e.ship_booter_speed=138]="ship_booter_speed",e[e.ship_wreck_speed_rate=139]="ship_wreck_speed_rate",e[e.island_speed_rate=140]="island_speed_rate",e[e.attack_power_sub_rate_1=141]="attack_power_sub_rate_1",e[e.attack_power_sub_rate_2=142]="attack_power_sub_rate_2",e[e.physical_inc_sub_rate_1=143]="physical_inc_sub_rate_1",e[e.physical_inc_sub_rate_2=144]="physical_inc_sub_rate_2",e[e.magical_inc_sub_rate_1=145]="magical_inc_sub_rate_1",e[e.magical_inc_sub_rate_2=146]="magical_inc_sub_rate_2",e[e.skill_damage_sub_rate_1=147]="skill_damage_sub_rate_1",e[e.skill_damage_sub_rate_2=148]="skill_damage_sub_rate_2",e[e.resource_recovery_rate=149]="resource_recovery_rate",e[e.weapon_dam=151]="weapon_dam",e))(Y||{});var pn=require("tiny-typed-emitter");var L,X,N,g,bn,Z,dn,vn=class extends pn.TypedEmitter{constructor(_,s,n=!0,a=!!process.env.DEV){super();W(this,g);W(this,Z);V(this,"PartyStatusEffectRegistry");V(this,"LocalStatusEffectRegistry");W(this,L,void 0);W(this,X,void 0);W(this,N,void 0);V(this,"debug");V(this,"trace",!1);this.PartyStatusEffectRegistry=new Map,this.LocalStatusEffectRegistry=new Map,this.debug=a,en(this,L,_),en(this,X,s),en(this,N,n)}getStatusEffectRegistryForPlayer(_,s){let n=this.getPlayerRegistry(s),a=n.get(_);if(a)return a;let l=new Map;return n.set(_,l),l}hasStatusEffectRegistryForPlayer(_,s){return this.getPlayerRegistry(s).has(_)}getPlayerRegistry(_){switch(_){case 1:return this.LocalStatusEffectRegistry;case 0:return this.PartyStatusEffectRegistry;default:break}return this.LocalStatusEffectRegistry}RemoveLocalObject(_,s){let n=this.LocalStatusEffectRegistry.get(_);if(n)for(let[,a]of n)this.RemoveStatusEffect(_,a.instanceId,1,void 0,s);this.LocalStatusEffectRegistry.delete(_)}RemovePartyObject(_,s){let n=this.PartyStatusEffectRegistry.get(_);if(n)for(let[,a]of n)this.RemoveStatusEffect(_,a.instanceId,0,void 0,s);this.PartyStatusEffectRegistry.delete(_)}RegisterStatusEffect(_){let s=this.getStatusEffectRegistryForPlayer(_.targetId,_.type),n=s.get(_.instanceId);n?R(this,N)&&n.expirationTimer&&(clearTimeout(n.expirationTimer),n.expirationTimer=void 0):_.effectType===0&&this.emit("shieldApplied",_),s.set(_.instanceId,_),this.SetupStatusEffectTimeout(_)}HasAnyStatusEffect(_,s,n,a){if(!this.hasStatusEffectRegistryForPlayer(_,s))return!1;let l=this.getStatusEffectRegistryForPlayer(_,s);for(let[,d]of l)if(!(!R(this,N)&&!this.IsReplayStatusEffectValidElseRemove(d,a))){for(let m of n)if(m===d.statusEffectId)return!0}return!1}IsReplayStatusEffectValidElseRemove(_,s){return _.expireAt===void 0||_.expireAt.getTime()>s.getTime()?!0:(this.ExpireStatusEffectByTimeout(_),!1)}HasAnyStatusEffectFromParty(_,s,n,a,l){if(!this.hasStatusEffectRegistryForPlayer(_,s))return!1;let d=this.getStatusEffectRegistryForPlayer(_,s);for(let[,m]of d)if(!(!R(this,N)&&!this.IsReplayStatusEffectValidElseRemove(m,l))&&a.includes(m.statusEffectId)&&(this.ValidForWholeRaid(m)||R(this,L).getPartyIdFromEntityId(m.sourceId)===n))return!0;return!1}RemoveStatusEffect(_,s,n,a,l){if(!this.hasStatusEffectRegistryForPlayer(_,n))return;let d=this.getStatusEffectRegistryForPlayer(_,n),m=d.get(s);m&&(R(this,N)&&(clearTimeout(m.expirationTimer),m.expirationTimer=void 0),d.delete(s),a===4&&(R(this,N)||this.IsReplayStatusEffectValidElseRemove(m,l))&&this.RegisterValueUpdate(m,m.value,0))}GetStatusEffects(_,s,n){if(!this.hasStatusEffectRegistryForPlayer(_,s))return[];let a=this.getStatusEffectRegistryForPlayer(_,s);if(!R(this,N))for(let[,l]of a)this.IsReplayStatusEffectValidElseRemove(l,n);return[...a.values()]}GetStatusEffectsFromParty(_,s,n,a){if(!this.hasStatusEffectRegistryForPlayer(_,s))return[];let l=this.getStatusEffectRegistryForPlayer(_,s);if(!R(this,N))for(let[,d]of l)this.IsReplayStatusEffectValidElseRemove(d,a);return[...l.values()].filter(d=>this.ValidForWholeRaid(d)?!0:n===R(this,L).getPartyIdFromEntityId(d.sourceId))}Clear(_){let s=0;for(let[,a]of this.LocalStatusEffectRegistry){for(let[,l]of a)this.RemoveStatusEffect(l.targetId,l.instanceId,l.type,void 0,_);s+=a.size}let n=0;for(let[,a]of this.PartyStatusEffectRegistry){for(let[,l]of a)this.RemoveStatusEffect(l.targetId,l.instanceId,l.type,void 0,_);n+=a.size}this.trace&&console.log("On Clear SE in local",s,"in party",n),this.LocalStatusEffectRegistry.clear(),this.PartyStatusEffectRegistry.clear()}UpdateDuration(_,s,n,a){let d=this.getStatusEffectRegistryForPlayer(s,a).get(_);if(d){let m=n-d.timestamp;if(R(this,N)&&d.expirationTimer&&(this.trace&&console.log("Clearing timeout for",d.instanceId,"because of duration change"),clearTimeout(d.expirationTimer),d.expirationTimer=void 0),d.expireAt){let h=d.expireAt.getTime()+Number(m),v=h-d.pktTime.getTime();v>0?(this.trace&&console.log("Extending duration by",m,"ms","New timeout delay",v,"from",d.expireAt.toISOString(),"to",new Date(h).toISOString()),R(this,N)&&(d.expirationTimer=setTimeout(this.ExpireStatusEffectByTimeout.bind(this,d),v)),d.expireAt=new Date(h),d.timestamp=n):d.expireAt=void 0}}else this.debug&&console.error("Tried to update duration for SE with instanceId",_," on target",s,"but where is no such SE registered")}SyncStatusEffect(_,s,n,a,l){let d=z(this,Z,dn).call(this,s,l),m=d?0:1,h=d?s:n;if(!h)return;let c=this.getStatusEffectRegistryForPlayer(h,m).get(_);if(!c)return;let E=c.value;c.value=a,this.RegisterValueUpdate(c,E,a)}ValidForWholeRaid(_){return(_.buffCategory===3||_.buffCategory===1||_.buffCategory===2)&&_.category===1&&_.showType===1}SetupStatusEffectTimeout(_){if(_.expirationDelay>0&&_.expirationDelay<604800){let s=_.pktTime.getTime()>_.occurTime.getTime()?_.pktTime:_.occurTime,n=Math.ceil(_.expirationDelay*1e3),a=s.getTime()+n+vn.TIMEOUT_DELAY_MS-_.pktTime.getTime();_.expireAt=new Date(_.pktTime.getTime()+a),this.trace&&console.log("Setting up statuseffect expiration time for",_.name,_.instanceId,"to",_.expireAt.toISOString(),"with delay",a),R(this,N)&&(_.expirationTimer=setTimeout(this.ExpireStatusEffectByTimeout.bind(this,_),a))}}ExpireStatusEffectByTimeout(_){this.debug&&console.error("Triggered timeout on",_.name,"with iid",_.instanceId),this.RemoveStatusEffect(_.targetId,_.instanceId,_.type,void 0,new Date)}RegisterValueUpdate(_,s,n){_.effectType===0&&this.emit("shieldChanged",_,s,n)}newPC(_,s,n){let a=z(this,Z,dn).call(this,_.pcStruct.characterId,s);a?this.RemovePartyObject(_.pcStruct.characterId,n):this.RemoveLocalObject(_.pcStruct.playerId,n);for(let l of _.pcStruct.statusEffectDatas)this.RegisterStatusEffect(this.buildStatusEffect(l,a?_.pcStruct.characterId:_.pcStruct.playerId,l.sourceId,a?0:1,n))}buildStatusEffect(_,s,n,a,l){let d=_.value?_.value.readUInt32LE():0,m=_.value?_.value.readUInt32LE(8):0,h=d<m?d:m,v=0,c=0,E=0,A="Unknown",B=1,C=R(this,X).skillBuff.get(_.statusEffectId);if(C){switch(A=C.name,C.category){case"debuff":v=1;break}switch(C.buffcategory){case"bracelet":c=1;break;case"etc":c=2;break;case"battleitem":c=3;break}switch(C.iconshowtype){case"all":E=1;break}switch(C.type){case"shield":B=0;break}}return{instanceId:_.effectInstanceId,sourceId:n,statusEffectId:_.statusEffectId,targetId:s,type:a,dbTarget:C?.target??"none",value:h,buffCategory:c,category:v,showType:E,expirationDelay:_.totalTime,expirationTimer:void 0,timestamp:_.endTick,expireAt:void 0,occurTime:_.occurTime,name:A,pktTime:l,effectType:B,stackCount:_.stackCount}}getStatusEffects(_,s,n,a){let l=[],d=[],m=z(this,g,bn).call(this,_,n),h=this.GetStatusEffects(m?_.characterId:_.entityId,m?0:1,a);for(let v of h)d.push([v.statusEffectId,v.sourceId,v.stackCount]);if(s){let v=z(this,g,bn).call(this,s,n),c=R(this,L).isEntityInParty(_.entityId),E=c?R(this,L).getPartyIdFromEntityId(_.entityId):void 0,A=c&&E?this.GetStatusEffectsFromParty(v?s.characterId:s.entityId,v?0:1,E,a):this.GetStatusEffects(v?s.characterId:s.entityId,v?0:1,a);for(let B of A)B.type===1&&B.category===1&&B.sourceId!==_.entityId&&B.dbTarget==="self"||l.push([B.statusEffectId,B.sourceId,B.stackCount])}return[d,l]}},Q=vn;L=new WeakMap,X=new WeakMap,N=new WeakMap,g=new WeakSet,bn=function(_,s){if(_.entityType!==1)return!1;let n=_;return z(this,Z,dn).call(this,n.characterId,s)},Z=new WeakSet,dn=function(_,s){let n=R(this,L).isCharacterInParty(s),a=R(this,L).isCharacterInParty(_);if(n){if(!a||_===s)return!1;let l=R(this,L).getPartyIdFromCharacterId(s),d=R(this,L).getPartyIdFromCharacterId(_);return l===d}return!1},V(Q,"TIMEOUT_DELAY_MS",1e3);var un=class{#n;#e;#r;#_;entities=new Map;localPlayer;constructor(r,_,s,n){this.#n=r,this.#e=_,this.#r=s,this.#_=n,this.localPlayer={entityId:0n,entityType:1,name:"You",class:0,gearLevel:0,characterId:0n,stance:0,stats:new Map,skills:new Map}}processNewPC(r){let _=r.parsed;if(!_)return;let s={entityId:_.pcStruct.playerId,entityType:1,name:_.pcStruct.name,class:_.pcStruct.classId,gearLevel:_.pcStruct.maxItemLevel,characterId:_.pcStruct.characterId,stance:0,stats:this.#_.getStatPairMap(_.pcStruct.statPair),skills:new Map};this.entities.set(s.entityId,s);let n=this.#n.getEntityId(s.characterId);return n&&this.#e.changeEntityId(n,_.pcStruct.playerId),this.#n.addMapping(s.characterId,s.entityId),this.#e.completeEntry(s.characterId,s.entityId),this.#r.newPC(_,this.localPlayer.characterId,r.time),s}processInitEnv(r){let _=r.parsed;if(!_)return;this.localPlayer.entityId!==0n&&this.#e.changeEntityId(this.localPlayer.entityId,_.playerId),this.entities.clear();let s={entityId:_.playerId,entityType:1,name:this.localPlayer.name,class:this.localPlayer.class,gearLevel:this.localPlayer.gearLevel,characterId:this.localPlayer.characterId,stance:this.localPlayer.stance,stats:this.localPlayer.stats,skills:this.localPlayer.skills};this.localPlayer=s,this.entities.set(s.entityId,s),this.#n.clear(),this.#r.Clear(r.time),s.characterId!==0n&&this.#n.addMapping(s.characterId,s.entityId),this.localPlayer&&this.localPlayer.characterId&&this.localPlayer.characterId>0n&&this.#e.completeEntry(this.localPlayer.characterId,_.playerId)}processInitPC(r){let _=r.parsed;if(!_)return;this.entities.clear();let s={entityId:_.playerId,entityType:1,name:_.name,class:_.classId,gearLevel:_.gearLevel,characterId:_.characterId,stance:0,stats:this.#_.getStatPairMap(_.statPair),skills:new Map};this.localPlayer=s,this.entities.set(s.entityId,s),this.#n.addMapping(s.characterId,s.entityId),this.#e.setOwnName(_.name),this.#e.completeEntry(s.characterId,_.playerId),this.#r.RemoveLocalObject(_.playerId,r.time);for(let n of _.statusEffectDatas){let a=this.getSourceEntity(n.sourceId);this.#r.RegisterStatusEffect(this.#r.buildStatusEffect(n,_.playerId,a.entityId,1,r.time))}return s}processNewNpc(r){let _=r.parsed;if(!_)return;let s=!1,n=this.#_.npc.get(_.npcStruct.typeId);n&&[6,7,9,10].includes(tn[n.grade])&&(s=!0);let a={entityId:_.npcStruct.objectId,entityType:2,name:n?.name??_.npcStruct.objectId.toString(16),typeId:_.npcStruct.typeId,isBoss:s,grade:n?.grade??"none",pushimmune:n?.pushimmune??!1,stats:this.#_.getStatPairMap(_.npcStruct.statPair),level:_.npcStruct.level,balanceLevel:_.npcStruct.balanceLevel??_.npcStruct.level},l=this.#_.getNpcEsther(_.npcStruct.typeId);l!==void 0&&(a.entityType=4,a.name=l.name,a.icon=l.icon),this.entities.set(a.entityId,a),this.#r.RemoveLocalObject(_.npcStruct.objectId,r.time);for(let d of _.npcStruct.statusEffectDatas){let m=this.getSourceEntity(d.sourceId);this.#r.RegisterStatusEffect(this.#r.buildStatusEffect(d,_.npcStruct.objectId,m.entityId,1,r.time))}return a}processNewNpcSummon(r){let _=r.parsed;if(!_)return;let s=!1,n=this.#_.npc.get(_.npcData.typeId);n&&["boss","raid","epic_raid","commander"].includes(n.grade)&&(s=!0);let a={entityId:_.npcData.objectId,entityType:3,name:n?.name??_.npcData.objectId.toString(16),ownerId:_.ownerId,typeId:_.npcData.typeId,isBoss:s,grade:n?.grade??"none",pushimmune:n?.pushimmune??!1,stats:this.#_.getStatPairMap(_.npcData.statPair),level:_.npcData.level,balanceLevel:_.npcData.balanceLevel??_.npcData.level};this.#r.RemoveLocalObject(_.npcData.objectId,r.time);for(let l of _.npcData.statusEffectDatas){let d=this.getSourceEntity(l.sourceId);this.#r.RegisterStatusEffect(this.#r.buildStatusEffect(l,_.npcData.objectId,d.entityId,1,r.time))}return this.entities.set(a.entityId,a),a}getPlayerSetOptions(r){let _=new Map;r.forEach(n=>{if(n.id&&n.slot&&n.slot>=1&&n.slot<=6){let a=this.#_.itemSet.items.get(n.id);if(a){let l=_.get(a.setname);l||(l=new Map,_.set(a.setname,l)),l.set(a.level,(l.get(a.level)??0)+1)}}});let s=[];return _.forEach((n,a)=>{let l=this.#_.itemSet.seteffects.get(a);if(!l)return;let d=0,m=0;for(let[h,v]of[...n.entries()].sort((c,E)=>E[0]-c[0])){let c=l.get(h);if(!c)return;for(let[E,A]of[...c.entries()])E>d&&v+m>=E&&(s.push(...A.options),d=Math.max(d,E));m=v}}),s}getSourceEntity(r){let _=this.entities.get(r);if((_?.entityType===5||_?.entityType===3)&&(r=_.ownerId),_=this.entities.get(r),_)return _;let s={entityId:r,entityType:2,name:r.toString(16),stats:new Map};return this.entities.set(r,s),s}guessIsPlayer(r,_){let s=this.#_.getSkillClassId(_);if(s!==0){let n;if(r.entityType===1){let a=r;if(a.class===s)return a;n={entityId:a.entityId,entityType:1,name:a.name,class:s,gearLevel:a.gearLevel,characterId:a.characterId,stance:a.stance,stats:a.stats,skills:new Map}}else n={entityId:r.entityId,entityType:1,name:r.name,class:s,gearLevel:0,characterId:0n,stance:0,stats:new Map,skills:new Map};return this.entities.set(r.entityId,n),n}return r}getOrCreateEntity(r){let _=this.entities.get(r);return _||(_={entityId:r,entityType:0,name:r.toString(16),stats:new Map},this.entities.set(r,_)),_}};var Pn=require("tiny-typed-emitter");var An={isLive:!0,dontResetOnZoneChange:!1,resetAfterPhaseTransition:!1,splitOnPhaseTransition:!1},hn=class extends Pn.TypedEmitter{#n;encounters;#e;#r;#_;options;resetTimer;phaseTransitionResetRequest;phaseTransitionResetRequestTime;#i;constructor(r,_,s,n){super(),this.#e=r,this.#r=_,this.#_=s,this.options={...An,...n},this.resetTimer=null,this.phaseTransitionResetRequest=!1,this.phaseTransitionResetRequestTime=0,this.#i=new Map,this.encounters=[],this.#n={startedOn:0,lastCombatPacket:0,fightStartedOn:0,localPlayer:this.#e.localPlayer.name,currentBoss:void 0,entities:new Map,damageStatistics:{totalDamageDealt:0,topDamageDealt:0,totalDamageTaken:0,topDamageTaken:0,totalHealingDone:0,topHealingDone:0,totalShieldDone:0,topShieldDone:0,debuffs:new Map,buffs:new Map,topShieldGotten:0,totalEffectiveShieldingDone:0,topEffectiveShieldingDone:0,topEffectiveShieldingUsed:0,effectiveShieldingBuffs:new Map,appliedShieldingBuffs:new Map}}}onCounterAttack(r,_){let s=this.updateEntity(r,{},_);s.hits.counter+=1}onInitEnv(r,_){this.options.isLive?(this.#n.entities.forEach((s,n,a)=>{s.hits.total===0&&a.delete(n)}),this.options.dontResetOnZoneChange===!1&&this.resetTimer===null&&(this.resetTimer=setTimeout(()=>{this.resetState(+_+6e3)},6e3),this.emit("message","new-zone"))):(this.splitEncounter(_),this.emit("message","new-zone"))}splitEncounter(r){if(this.#n.fightStartedOn!==0&&(this.#n.damageStatistics.totalDamageDealt!==0||this.#n.damageStatistics.totalDamageTaken!==0)){let _=structuredClone(this.#n);this.applyBreakdowns(_.entities),this.encounters.push(_)}this.resetState(+r)}getBossIfStillExist(){if(this.#n.currentBoss?.id){let r=BigInt(`0x0${this.#n.currentBoss?.id}`);return this.#e.entities.has(r)?this.#n.currentBoss:void 0}}resetState(r){this.cancelReset(),this.resetBreakdowns(),this.#n={startedOn:+r,lastCombatPacket:+r,fightStartedOn:0,localPlayer:this.#e.localPlayer.name,currentBoss:this.getBossIfStillExist(),entities:new Map,damageStatistics:{totalDamageDealt:0,topDamageDealt:0,totalDamageTaken:0,topDamageTaken:0,totalHealingDone:0,topHealingDone:0,totalShieldDone:0,topShieldDone:0,debuffs:new Map,buffs:new Map,appliedShieldingBuffs:new Map,effectiveShieldingBuffs:new Map,topEffectiveShieldingDone:0,topEffectiveShieldingUsed:0,topShieldGotten:0,totalEffectiveShieldingDone:0}},this.emit("reset-state",this.#n)}cancelReset(){this.resetTimer&&clearTimeout(this.resetTimer),this.resetTimer=null}onPhaseTransition(r,_){this.options.isLive&&(this.emit("message",`phase-transition-${r}`),this.options.resetAfterPhaseTransition&&(this.phaseTransitionResetRequest=!0,this.phaseTransitionResetRequestTime=+_)),!this.options.isLive&&this.options.splitOnPhaseTransition&&this.splitEncounter(_)}updateOptions(r){this.options={...this.options,...r}}onDeath(r,_){let s=this.#n.entities.get(r.name),n=0;s?s.isDead?n=s.deaths:n=s.deaths+1:n=1,this.updateEntity(r,{isDead:!0,deathTime:+_,deaths:n},_)}onDamage(r,_,s,n,a,l){if((n.modifier&15)===11&&n.skillId===0&&n.skillEffectId===0)return;this.phaseTransitionResetRequest&&this.phaseTransitionResetRequestTime>0&&this.phaseTransitionResetRequestTime<+l-8e3&&(this.resetState(+l),this.phaseTransitionResetRequest=!1);let[d,m]=this.#r.getStatusEffects(r,s,this.#e.localPlayer.characterId,l);if(this.#_.isBattleItem(n.skillEffectId,"attack")&&_&&_.entityType===5){let M=_;n.skillEffectId=M.skillEffectId}let h=this.updateEntity(r,{},l),v=this.updateEntity(s,{currentHp:n.targetCurHp,maxHp:n.targetMaxHp},l);if(!h||!v)return;!v.isPlayer&&n.targetCurHp<0&&(n.damage=n.damage+n.targetCurHp);let c=n.skillId;n.skillId===0&&n.skillEffectId!==0&&(c=n.skillEffectId);let E=h.skills.get(c);E||(E={...this.createEntitySkill(),id:c,...this.getSkillNameIcon(n.skillId,n.skillEffectId)},h.skills.set(c,E));let A=n.modifier&15,B=(n.modifier>>4&7)-1,C=(A&9)!==0,O=new Set,K=new Set;d.forEach(([M])=>{O.add(M)}),m.forEach(([M])=>{K.add(M)}),E.damageInfo.damageDealt+=n.damage,n.damage>E.maxDamage&&(E.maxDamage=n.damage),h.hits.total+=1,E.hits.total+=1,h.damageInfo.damageDealt+=n.damage,v.damageTaken+=n.damage;let fn=C?1:0;h.hits.crit+=fn,E.hits.crit+=fn;let y=!1,nn=!1,_n=this.#_.getSkillEffectDirectionalMask(n.skillEffectId)-1;if(_n===0||_n===2){nn=B===0;let M=nn?1:0;h.hits.backAttack+=M,h.hits.totalBackAttack+=1,E.hits.backAttack+=M,E.hits.totalBackAttack+=1}if(_n===1||_n===2){y=B===1;let M=y?1:0;h.hits.frontAttack+=M,h.hits.totalFrontAttack+=1,E.hits.frontAttack+=M,E.hits.totalFrontAttack+=1}if(h.isPlayer){this.#n.damageStatistics.totalDamageDealt+=n.damage,this.#n.damageStatistics.topDamageDealt=Math.max(this.#n.damageStatistics.topDamageDealt,h.damageInfo.damageDealt);let M=!1,G=!1;O.forEach(o=>{if(!this.#n.damageStatistics.buffs.has(o)){let q=this.#_.getStatusEffectHeaderData(o);q&&this.#n.damageStatistics.buffs.set(o,q)}let x=this.#n.damageStatistics.buffs.get(o);x&&!M&&(M=(x.buffcategory==="classskill"||x.buffcategory==="identity"||x.buffcategory==="ability")&&x.source.skill!==void 0&&x.target===1&&this.#_.isSupportClassId(x.source.skill.classid));let U=E.damageDealtBuffedBy.get(o)??0;E.damageDealtBuffedBy.set(o,U+n.damage);let J=h.damageDealtBuffedBy.get(o)??0;h.damageDealtBuffedBy.set(o,J+n.damage);let j=h.hits.hitsBuffedBy.get(o)??0;h.hits.hitsBuffedBy.set(o,j+1);let $=E.hits.hitsBuffedBy.get(o)??0;E.hits.hitsBuffedBy.set(o,$+1)}),K.forEach(o=>{if(!this.#n.damageStatistics.debuffs.has(o)){let q=this.#_.getStatusEffectHeaderData(o);q&&this.#n.damageStatistics.debuffs.set(o,q)}let x=this.#n.damageStatistics.debuffs.get(o);x&&!G&&(G=(x.buffcategory==="classskill"||x.buffcategory==="identity"||x.buffcategory==="ability")&&x.source.skill!==void 0&&x.target===1&&this.#_.isSupportClassId(x.source.skill.classid));let U=E.damageDealtDebuffedBy.get(o)??0;E.damageDealtDebuffedBy.set(o,U+n.damage);let J=h.damageDealtDebuffedBy.get(o)??0;h.damageDealtDebuffedBy.set(o,J+n.damage);let j=h.hits.hitsDebuffedBy.get(o)??0;h.hits.hitsDebuffedBy.set(o,j+1);let $=E.hits.hitsDebuffedBy.get(o)??0;E.hits.hitsDebuffedBy.set(o,$+1)});let t=G?1:0,In=M?1:0;if(E.damageInfo.damageDealtBuffedBySupport+=M?n.damage:0,E.damageInfo.damageDealtDebuffedBySupport+=G?n.damage:0,h.damageInfo.damageDealtBuffedBySupport+=M?n.damage:0,h.damageInfo.damageDealtDebuffedBySupport+=G?n.damage:0,h.hits.hitsBuffedBySupport+=In,h.hits.hitsDebuffedBySupport+=t,E.hits.hitsBuffedBySupport+=In,E.hits.hitsDebuffedBySupport+=t,n.damage>0&&h.isPlayer){let o={multDmg:{sumRate:0,totalRate:1,values:Array()},addDmg:{sumRate:0,values:Array()},crit:{sumRate:0,values:Array()},critDmgRate:2};if(d.forEach(([D,w,p])=>{let P=this.#e.entities.get(w);if(!P)return;let b=this.getBuffAfterTripods(this.#_.skillBuff.get(D),P,n);if(b){if(b.type==="skill_damage_amplify"&&b.statuseffectvalues&&P.entityType===1&&w!==r.entityId){let I=b.statuseffectvalues[0]??0,S=b.statuseffectvalues[4]??0;if((I===0||I===n.skillId)&&(S===0||S===n.skillEffectId)){let k=b.statuseffectvalues[1]??0;if(k!==0){let T=k/1e4*p;o.multDmg.values.push({casterEntity:P,rate:T}),o.multDmg.sumRate+=T,o.multDmg.totalRate*=1+T}}}else b.type==="attack_power_amplify"&&b.statuseffectvalues&&P.entityType===1&&r.entityId;b.passiveoption.forEach(I=>{if(H[I.type]===2)if(P.entityType===1&&w!==r.entityId)if(I.keystat==="critical_hit_rate"){let S=I.value;if(S!==0){let k=S/1e4*p;o.crit.values.push({casterEntity:P,rate:k}),o.crit.sumRate+=k}}else if(I.keystat==="attack_power_sub_rate_2"){let S=I.value;if(S!==0){let k=S/1e4*p;o.addDmg.values.push({casterEntity:P,rate:k}),o.addDmg.sumRate+=k}}else if(I.keystat==="skill_damage_sub_rate_2"){let S=I.value;if(S!==0){let k=S/1e4*p;o.multDmg.values.push({casterEntity:P,rate:k}),o.multDmg.sumRate+=k,o.multDmg.totalRate*=1+k}}else I.keystat;else I.keystat==="critical_dam_rate"&&b.category==="buff"&&(o.critDmgRate+=I.value/1e4*p);else if(H[I.type]===4){let S=this.#_.combatEffect.get(I.keyindex);o.critDmgRate+=p*this.getCritMultiplierFromCombatEffect(S,{self:r,target:s,caster:P,skill:this.#_.skill.get(c),hitOption:B,targetCount:a})}})}}),m.forEach(([D,w,p])=>{let P=this.#e.entities.get(w);if(!P||P.entityType!==1||w===r.entityId)return;let b=this.getBuffAfterTripods(this.#_.skillBuff.get(D),P,n);if(b){if(b.type==="instant_stat_amplify"&&b.statuseffectvalues){let I=b.statuseffectvalues[0]??0;if(I!==0){let S=I/1e4*p;o.crit.values.push({casterEntity:P,rate:S}),o.crit.sumRate+=S}if(n.damageType===0){let S=b.statuseffectvalues[2]??0;if(S!==0){let T=-(S/1e4)*p*.5;o.multDmg.values.push({casterEntity:P,rate:T}),o.multDmg.sumRate+=T,o.multDmg.totalRate*=1+T}let k=b.statuseffectvalues[7]??0;if(k!==0){let T=k/1e4*p;o.multDmg.values.push({casterEntity:P,rate:T}),o.multDmg.sumRate+=T,o.multDmg.totalRate*=1+T}}else if(n.damageType===1){let S=b.statuseffectvalues[3]??0;if(S!==0){let T=-(S/1e4)*p*.5;o.multDmg.values.push({casterEntity:P,rate:T}),o.multDmg.sumRate+=T,o.multDmg.totalRate*=1+T}let k=b.statuseffectvalues[8]??0;if(k!==0){let T=k/1e4*p;o.multDmg.values.push({casterEntity:P,rate:T}),o.multDmg.sumRate+=T,o.multDmg.totalRate*=1+T}}}if(b.type==="skill_damage_amplify"&&b.statuseffectvalues){let I=b.statuseffectvalues[0]??0,S=b.statuseffectvalues[4]??0;if((I===0||I===n.skillId)&&(S===0||S===n.skillEffectId)){let k=b.statuseffectvalues[1]??0;if(k!==0){let T=k/1e4*p;o.multDmg.values.push({casterEntity:P,rate:T}),o.multDmg.sumRate+=T,o.multDmg.totalRate*=1+T}}}if(b.type==="directional_attack_amplify"&&b.statuseffectvalues){if(y){let I=b.statuseffectvalues[0]??0;if(I!==0){let S=I/1e4*p;o.multDmg.values.push({casterEntity:P,rate:S}),o.multDmg.sumRate+=S,o.multDmg.totalRate*=1+S}}if(nn){let I=b.statuseffectvalues[4]??0;if(I!==0){let S=I/1e4*p;o.multDmg.values.push({casterEntity:P,rate:S}),o.multDmg.sumRate+=S,o.multDmg.totalRate*=1+S}}}}}),o.crit.values.length>0){let D=this.#_.skill.get(n.skillId);r.itemSet?.forEach(w=>{if(H[w.type]===2&&Y[w.keystat]===76)o.critDmgRate+=w.value/1e4;else if(H[w.type]===4){let p=this.#_.combatEffect.get(w.keyindex);o.critDmgRate+=this.getCritMultiplierFromCombatEffect(p,{self:r,target:s,caster:r,skill:D,hitOption:B,targetCount:a})}r.skills.get(n.skillId)?.tripods.forEach(p=>{let P=new Map;p.options.forEach(b=>{let I=ln[b.type];if(I===45){if((b.params[0]??0)===0||n.skillEffectId===(b.params[0]??0)){let S=b.params[1];if(S){let k=this.#_.combatEffect.get(S);k&&P.set(k.id,k)}}}else if(I===46)P.delete(b.params[0]??0);else if(I===104){if((b.params[0]??0)===0||n.skillEffectId===(b.params[0]??0)){let S=P.get(b.params[1]??0);if(S){let k=structuredClone(S);P.set(S.id,k),k.effects.forEach(T=>{T.actions.forEach(wn=>{for(let F=0;F<b.params.length-2;F++)rn[b.paramtype]===1?wn.args[F]*=1+(b.params[F+2]??0)/100:wn.args[F]+=b.params[F+2]??0})})}}}else I===29&&((b.params[0]??0)===0||n.skillEffectId===(b.params[0]??0))&&(o.critDmgRate+=(b.params[1]??0)/1e4)}),P.forEach(b=>{o.critDmgRate+=this.getCritMultiplierFromCombatEffect(b,{self:r,target:s,caster:r,skill:D,hitOption:B,targetCount:a})})})})}let x=0;if(o.crit.values.length>0){let D,w;C?(D=n.damage,w=D/o.critDmgRate):(w=n.damage,D=w*o.critDmgRate),x=(D-w)/D*o.crit.sumRate}let U=(1+x)*(1+o.addDmg.sumRate)*o.multDmg.totalRate-1,J=x+o.addDmg.sumRate+(o.multDmg.totalRate-1),j=U*n.damage/(J*(1+U)),$=x*j/o.crit.sumRate;o.crit.values.forEach(D=>{let w=D.rate*$,p=this.#n.entities.get(D.casterEntity.name);p&&(p.damageInfo.rdpsDamageGiven+=w),h.damageInfo.rdpsDamageReceived+=w,E.damageInfo.rdpsDamageReceived+=w}),o.addDmg.values.forEach(D=>{let w=D.rate*j,p=this.#n.entities.get(D.casterEntity.name);p&&(p.damageInfo.rdpsDamageGiven+=w),h.damageInfo.rdpsDamageReceived+=w,E.damageInfo.rdpsDamageReceived+=w});let q=(o.multDmg.totalRate-1)*j/o.multDmg.sumRate;o.multDmg.values.forEach(D=>{let w=D.rate*q,p=this.#n.entities.get(D.casterEntity.name);p&&(p.damageInfo.rdpsDamageGiven+=w),h.damageInfo.rdpsDamageReceived+=w,E.damageInfo.rdpsDamageReceived+=w})}let Tn={timestamp:+l,damage:n.damage,targetEntity:v.id,isCrit:C,isBackAttack:nn,isFrontAttack:y,isBuffedBySupport:M,isDebuffedBySupport:G,buffedBy:[...O],debuffedBy:[...K]},Dn=BigInt("0x"+h.id);this.addBreakdown(Dn,c,Tn)}v.isPlayer&&(this.#n.damageStatistics.totalDamageTaken+=n.damage,this.#n.damageStatistics.topDamageTaken=Math.max(this.#n.damageStatistics.topDamageTaken,v.damageTaken)),v.isBoss&&(this.#n.currentBoss=v),this.#n.fightStartedOn===0&&(this.#n.fightStartedOn=+l),this.#n.lastCombatPacket=+l}getBuffAfterTripods(r,_,s){if(!r||_.entityType!==1)return r;let n=structuredClone(r);return _.skills.get(s.skillId)?.tripods.forEach(a=>{a.options.forEach(l=>{let d=ln[l.type];if(d===19){if(((l.params[0]??0)===0||s.skillEffectId===(l.params[0]??0))&&n.id===(l.params[1]??0)){let m=new Map;for(let h=2;h<l.params.length;h+=2)l.params[h]&&l.params[h+1]&&m.set(l.params[h]??0,l.params[h+1]??0);n.passiveoption.forEach(h=>{let v=m.get(Y[h.keystat]);H[h.type]===2&&v&&(rn[l.paramtype]===0?h.value+=v:h.value*=1+v/100)})}}else if(d===42){if(((l.params[0]??0)===0||s.skillEffectId===(l.params[0]??0))&&n.id===(l.params[1]??0)){let m=Y[l.params[2]??0],h=l.params[3]??0;m&&h!==void 0&&n.passiveoption.push({type:"stat",keystat:m,keyindex:0,value:h})}}else if(d===21&&n.statuseffectvalues&&((l.params[0]??0)===0||s.skillEffectId===(l.params[0]??0))&&n.id===(l.params[1]??0))if((l.paramtype[2]??0)===0)n.statuseffectvalues=l.params.slice(3);else{let m=[];for(let h=0;h<Math.max(n.statuseffectvalues.length,l.params.length-3);h++)l.params[h+3]&&m.push((n.statuseffectvalues[h]??0)*(1+(l.params[h+3]??0)/100));n.statuseffectvalues=m}})}),n}getCritMultiplierFromCombatEffect(r,_){if(!r)return 0;let s=0;return r.effects.filter(n=>n.actions.find(a=>sn[a.type]===4)).forEach(n=>{this.#_.isCombatEffectConditionsValid({effect:n,..._})&&n.actions.filter(a=>sn[a.type]===4).forEach(a=>{s+=(a.args[0]??0)/100})}),s}onStartSkill(r,_,s){let n=this.updateEntity(r,{isDead:!1},s);if(n){n.hits.casts+=1;let a=n.skills.get(_);a||(a={...this.createEntitySkill(),id:_,...this.getSkillNameIcon(_,0)},n.skills.set(_,a)),a.hits.casts+=1}}onShieldUsed(r,_,s,n){if(n<0&&console.error("Shield change values was negative, shield ammount increased"),r.entityType===1&&_.entityType===1){if(!this.#n.damageStatistics.effectiveShieldingBuffs.has(s)){let v=this.#_.getStatusEffectHeaderData(s);v&&this.#n.damageStatistics.effectiveShieldingBuffs.set(s,v)}let a=new Date,l=this.updateEntity(r,{},a),d=this.updateEntity(_,{},a);l.damagePreventedByShield+=n;let m=l.damagePreventedByShieldBy.get(s)??0;l.damagePreventedByShieldBy.set(s,m+n),this.#n.damageStatistics.topEffectiveShieldingUsed=Math.max(l.damagePreventedByShield,this.#n.damageStatistics.topEffectiveShieldingUsed),d.damagePreventedWithShieldOnOthers+=n;let h=d.damagePreventedWithShieldOnOthersBy.get(s)??0;d.damagePreventedWithShieldOnOthersBy.set(s,h+n),this.#n.damageStatistics.topEffectiveShieldingDone=Math.max(d.damagePreventedWithShieldOnOthers,this.#n.damageStatistics.topEffectiveShieldingDone),this.#n.damageStatistics.totalEffectiveShieldingDone+=n}}onShieldApplied(r,_,s,n){let a=new Date,l=this.updateEntity(r,{},a),d=this.updateEntity(_,{},a);if(d.isPlayer&&l.isPlayer){if(!this.#n.damageStatistics.appliedShieldingBuffs.has(s)){let v=this.#_.getStatusEffectHeaderData(s);v&&this.#n.damageStatistics.appliedShieldingBuffs.set(s,v)}l.shieldReceived+=n,d.shieldDone+=n;let m=d.shieldDoneBy.get(s)??0;d.shieldDoneBy.set(s,m+n);let h=l.shieldReceivedBy.get(s)??0;l.shieldReceivedBy.set(s,h+n),this.#n.damageStatistics.topShieldDone=Math.max(d.shieldDone,this.#n.damageStatistics.topShieldDone),this.#n.damageStatistics.topShieldGotten=Math.max(l.shieldReceived,this.#n.damageStatistics.topShieldGotten),this.#n.damageStatistics.totalShieldDone+=n}}getSkillNameIcon(r,_){if(r===0&&_===0)return{name:"Bleed",icon:"buff_168.png"};if(r===0){let s=this.#_.skillEffect.get(_);if(s&&s.itemname)return{name:s.itemname,icon:s.icon??""};if(s){if(s.sourceskill){let n=this.#_.skill.get(s.sourceskill);if(n)return{name:n.name,icon:n.icon}}else{let n=this.#_.skill.get(Math.floor(_/10));if(n)return{name:n.name,icon:n.icon}}return{name:s.comment}}else return{name:this.#_.getSkillName(r)}}else{let s=this.#_.skill.get(r);return!s&&(s=this.#_.skill.get(r-r%10),!s)?{name:this.#_.getSkillName(r),icon:""}:s.summonsourceskill?(s=this.#_.skill.get(s.summonsourceskill),s?{name:s.name+" (Summon)",icon:s.icon}:{name:this.#_.getSkillName(r),icon:""}):s.sourceskill?(s=this.#_.skill.get(s.sourceskill),s?{name:s.name,icon:s.icon}:{name:this.#_.getSkillName(r),icon:""}):{name:s.name,icon:s.icon}}}updateEntity(r,_,s){let n={lastUpdate:+s},a=this.#n.entities.get(r.name),l={};if(!a||r.entityType===1&&a.isPlayer!==!0){if(r.entityType===1){let d=r;l={classId:d.class,gearScore:d.gearLevel,isPlayer:!0}}else if(r.entityType===2||r.entityType===3){let d=r;l={npcId:d.typeId,isBoss:d.isBoss}}else if(r.entityType===4){let d=r;l={npcId:d.typeId,isBoss:d.isBoss,isEsther:!0,icon:d.icon}}}return a?Object.assign(a,_,n,l):(a={...this.createEntity(),..._,...n,...l,name:r.name,id:r.entityId.toString(16)},this.#n.entities.set(r.name,a)),a}updateOrCreateEntity(r,_,s){if(!(!_.name||!_.id)){for(let[n,a]of this.#n.entities)if(_.id===a.id){this.#n.entities.delete(n),this.updateEntity(r,{...a,..._},s);return}this.updateEntity(r,_,s)}}createEntitySkill(){return{id:0,name:"",icon:"",damageInfo:{damageDealt:0,rdpsDamageReceived:0,rdpsDamageGiven:0,damageDealtDebuffedBySupport:0,damageDealtBuffedBySupport:0},maxDamage:0,hits:{casts:0,total:0,crit:0,backAttack:0,totalBackAttack:0,frontAttack:0,totalFrontAttack:0,counter:0,hitsDebuffedBySupport:0,hitsBuffedBySupport:0,hitsBuffedBy:new Map,hitsDebuffedBy:new Map},breakdown:[],damageDealtDebuffedBy:new Map,damageDealtBuffedBy:new Map}}createEntity(){return{lastUpdate:0,id:"",npcId:0,name:"",classId:0,isBoss:!1,isPlayer:!1,isDead:!1,deaths:0,deathTime:0,gearScore:0,currentHp:0,maxHp:0,damageInfo:{damageDealt:0,rdpsDamageReceived:0,rdpsDamageGiven:0,damageDealtDebuffedBySupport:0,damageDealtBuffedBySupport:0},healingDone:0,shieldDone:0,damageTaken:0,skills:new Map,hits:{casts:0,total:0,crit:0,backAttack:0,totalBackAttack:0,frontAttack:0,totalFrontAttack:0,counter:0,hitsDebuffedBySupport:0,hitsBuffedBySupport:0,hitsBuffedBy:new Map,hitsDebuffedBy:new Map},damageDealtDebuffedBy:new Map,damageDealtBuffedBy:new Map,damagePreventedByShieldBy:new Map,damagePreventedWithShieldOnOthersBy:new Map,shieldDoneBy:new Map,shieldReceivedBy:new Map,damagePreventedWithShieldOnOthers:0,damagePreventedByShield:0,shieldReceived:0}}getBroadcast(){let r={...this.#n};return r.entities=new Map,this.#n.entities.forEach((_,s)=>{!_.isPlayer&&!_.isEsther||r.entities.set(s,{..._})}),r.localPlayer=this.#e.localPlayer.name,r}resetBreakdowns(){this.#i.clear()}createBreakdownEntity(r){return this.#i.has(r)||this.#i.set(r,new Map),this.#i.get(r)}removeBreakdownEntry(r){this.#i.delete(r)}addBreakdown(r,_,s){let n=this.createBreakdownEntity(r);if(n.has(_))n.get(_).push(s);else{let a=new Array(s);n.set(_,a)}}getBreakdowns(r,_){let s=this.#i.get(r);if(s)return s.get(_)}clearBreakdowns(r,_){let s=this.#i.get(r);s&&s.delete(_)}applyBreakdowns(r,_=!0){r.forEach(s=>{s.skills.forEach(n=>{let a=BigInt("0x"+s.id),l=this.getBreakdowns(a,n.id);l&&(n.breakdown=[...l])})}),_&&this.resetBreakdowns()}};var on=class{characterIdToPartyId;entityIdToPartyId;raidInstanceToPartyInstances;ownName;characterNameToCharacterId;#n;constructor(r){this.characterIdToPartyId=new Map,this.entityIdToPartyId=new Map,this.raidInstanceToPartyInstances=new Map,this.characterNameToCharacterId=new Map,this.#n=r}add(r,_,s=void 0,n=void 0,a=void 0){!s&&!n||(s&&!n&&(n=this.#n.getEntityId(s)),n&&!s&&(s=this.#n.getEntityId(n)),s&&this.characterIdToPartyId.set(s,_),n&&this.entityIdToPartyId.set(n,_),a&&s&&this.characterNameToCharacterId.set(a,s),this.registerPartyId(r,_))}completeEntry(r,_){let s=this.getPartyIdFromCharacterId(r),n=this.getPartyIdFromEntityId(_);s&&n||(!s&&n&&this.characterIdToPartyId.set(r,n),!n&&s&&this.entityIdToPartyId.set(_,s))}changeEntityId(r,_){let s=this.getPartyIdFromEntityId(r);s&&(this.entityIdToPartyId.delete(r),this.entityIdToPartyId.set(_,s))}setOwnName(r){this.ownName=r}remove(r,_){if(_===this.ownName){this.removePartyMappings(r);return}let s=this.characterNameToCharacterId.get(_);if(this.characterNameToCharacterId.delete(_),!s)return;this.characterIdToPartyId.delete(s);let n=this.#n.getEntityId(s);n&&this.characterIdToPartyId.delete(n)}isCharacterInParty(r){return this.characterIdToPartyId.has(r)}isEntityInParty(r){return this.entityIdToPartyId.has(r)}getPartyIdFromCharacterId(r){return this.characterIdToPartyId.get(r)}getPartyIdFromEntityId(r){return this.entityIdToPartyId.get(r)}removePartyMappings(r){let _=this.getRaidInstanceId(r),s=_?this.raidInstanceToPartyInstances.get(_)??new Set([r]):new Set([r]);for(let[n,a]of this.characterIdToPartyId)if(s.has(a)){this.characterIdToPartyId.delete(n);for(let[l,d]of this.characterNameToCharacterId)if(n===d){this.characterNameToCharacterId.delete(l);break}}for(let[n,a]of this.entityIdToPartyId)s.has(a)&&this.entityIdToPartyId.delete(n)}getRaidInstanceId(r){for(let _ of this.raidInstanceToPartyInstances)if(_[1].has(r))return _[0]}registerPartyId(r,_){let s=this.raidInstanceToPartyInstances.get(r);s||(s=new Set,this.raidInstanceToPartyInstances.set(r,s)),s.add(_)}partyInfo(r,_,s){let n=r.parsed;if(n){if(n.memberDatas.length===1&&n.memberDatas[0]?.name===s.name){this.remove(n.partyInstanceId,n.memberDatas[0].name);return}this.removePartyMappings(n.partyInstanceId);for(let a of n.memberDatas){a.characterId===s.characterId&&this.setOwnName(a.name);let l=this.#n.getEntityId(a.characterId);if(l){let d=_.get(l);if(d&&d.entityType===1&&d.name!==a.name){let m=d;m.gearLevel=a.gearLevel,m.name=a.name,m.class=a.classId}}this.add(n.raidInstanceId,n.partyInstanceId,a.characterId,l,a.name)}}}};var mn=class{entityToCharacterId;characterToEntityId;constructor(){this.entityToCharacterId=new Map,this.characterToEntityId=new Map}addMapping(r,_){this.entityToCharacterId.set(_,r),this.characterToEntityId.set(r,_)}getCharacterId(r){return this.entityToCharacterId.get(r)}getEntityId(r){return this.characterToEntityId.get(r)}clear(){this.entityToCharacterId.clear(),this.characterToEntityId.clear()}};var Sn=class extends kn.TypedEmitter{#n;#e;#r;#_;#i;#a;#s;#l;#d;constructor(r,_,s){super(),this.#n=r,this.#e=_,this.#r=new mn,this.#_=new on(this.#r),this.#i=new Q(this.#_,this.#e,s.isLive??!0),this.#a=new un(this.#r,this.#_,this.#i,this.#e),this.#s=new hn(this.#a,this.#i,this.#e,s),this.#s.emit=this.emit.bind(this),this.#l=!1,this.#d=!1,this.#s.options.isLive&&setInterval(this.broadcastStateChange.bind(this),100),this.#n.on("AbilityChangeNotify",n=>{}).on("ActiveAbilityNotify",n=>{}).on("AddonSkillFeatureChangeNotify",n=>{}).on("BlockSkillStateNotify",n=>{}).on("CounterAttackNotify",n=>{let a=n.parsed;if(!a)return;let l=this.#a.entities.get(a.sourceId);l&&this.#s.onCounterAttack(l,n.time)}).on("DeathNotify",n=>{let a=n.parsed;if(!a)return;let l=this.#a.entities.get(a.targetId);l&&this.#s.onDeath(l,n.time)}).on("EquipChangeNotify",n=>{let a=n.parsed;if(!a)return;let l=this.#a.entities.get(a.objectId);!l||l.entityType!==1||(l.itemSet=this.#a.getPlayerSetOptions(a.equipItemDataList))}).on("IdentityStanceChangeNotify",n=>{let a=n.parsed;if(!a)return;let l=this.#a.entities.get(a.objectId);l&&l.entityType===1&&(l.stance=a.stance)}).on("IdentityGaugeChangeNotify",n=>{}).on("InitAbility",n=>{}).on("InitEnv",n=>{this.#a.processInitEnv(n),this.#s.onInitEnv(n,n.time)}).on("InitLocal",n=>{}).on("InitPC",n=>{let a=this.#a.processInitPC(n);if(a&&n.parsed){let l=this.#e.getStatPairMap(n.parsed.statPair);this.#s.updateOrCreateEntity(a,{id:a.entityId.toString(16),name:a.name,classId:a.class,isPlayer:!0,gearScore:a.gearLevel,currentHp:Number(l.get(1))||0,maxHp:Number(l.get(27))||0},n.time)}}).on("InitItem",n=>{let a=n.parsed;!a||a.storageType!==1||(this.#a.localPlayer.itemSet=this.#a.getPlayerSetOptions(a.itemDataList))}).on("MigrationExecute",n=>{if(this.#a.localPlayer.characterId!==0n)return;let a=n.parsed;a&&(this.#a.localPlayer.characterId=a.account_CharacterId1<a.account_CharacterId2?a.account_CharacterId1:a.account_CharacterId2)}).on("NewNpc",n=>{let a=this.#a.processNewNpc(n);if(a&&n.parsed){let l=this.#e.getStatPairMap(n.parsed.npcStruct.statPair);this.#s.updateOrCreateEntity(a,{id:a.entityId.toString(16),name:a.name,npcId:a.typeId,isPlayer:!1,isBoss:a.isBoss,currentHp:Number(l.get(1))||0,maxHp:Number(l.get(27))||0},n.time)}}).on("NewNpcSummon",n=>{let a=this.#a.processNewNpcSummon(n);if(a&&n.parsed){let l=this.#e.getStatPairMap(n.parsed.npcData.statPair);this.#s.updateOrCreateEntity(a,{id:a.entityId.toString(16),name:a.name,npcId:a.typeId,isPlayer:!1,isBoss:a.isBoss,currentHp:Number(l.get(1))||0,maxHp:Number(l.get(27))||0},n.time)}}).on("NewPC",n=>{let a=this.#a.processNewPC(n);if(a&&n.parsed){a.itemSet=this.#a.getPlayerSetOptions(n.parsed.pcStruct.equipItemDataList);let l=this.#e.getStatPairMap(n.parsed.pcStruct.statPair);this.#s.updateOrCreateEntity(a,{id:a.entityId.toString(16),name:a.name,classId:a.class,isPlayer:!0,gearScore:a.gearLevel,currentHp:Number(l.get(1))||0,maxHp:Number(l.get(27))||0},n.time)}}).on("NewProjectile",n=>{let a=n.parsed;if(!a)return;let l={entityId:a.projectileInfo.projectileId,entityType:5,name:a.projectileInfo.projectileId.toString(16),ownerId:a.projectileInfo.ownerId,skillEffectId:a.projectileInfo.skillEffect,skillId:a.projectileInfo.skillId,stats:new Map};this.#a.entities.set(l.entityId,l)}).on("ParalyzationStateNotify",n=>{}).on("PartyInfo",n=>{this.#_.partyInfo(n,this.#a.entities,this.#a.localPlayer)}).on("PartyLeaveResult",n=>{let a=n.parsed;a&&this.#_.remove(a.partyInstanceId,a.name)}).on("PartyPassiveStatusEffectAddNotify",n=>{}).on("PartyPassiveStatusEffectRemoveNotify",n=>{}).on("PartyStatusEffectAddNotify",n=>{let a=n.parsed;if(a)for(let l of a.statusEffectDatas){let d=a.playerIdOnRefresh!==0n?a.playerIdOnRefresh:l.sourceId,m=this.#a.getSourceEntity(d);this.#i.RegisterStatusEffect(this.#i.buildStatusEffect(l,a.characterId,m.entityId,0,n.time))}}).on("PartyStatusEffectRemoveNotify",n=>{let a=n.parsed;if(a)for(let l of a.statusEffectIds)this.#i.RemoveStatusEffect(a.characterId,l,0,a.reason,n.time)}).on("PartyStatusEffectResultNotify",n=>{let a=n.parsed;a&&this.#_.add(a.raidInstanceId,a.partyInstanceId,a.characterId)}).on("PassiveStatusEffectAddNotify",n=>{}).on("PassiveStatusEffectRemoveNotify",n=>{}).on("RaidBossKillNotify",n=>{this.#s.onPhaseTransition(1,n.time)}).on("RaidResult",n=>{this.#s.onPhaseTransition(0,n.time)}).on("RemoveObject",n=>{let a=n.parsed;if(a)for(let l of a.unpublishedObjects)this.#i.RemoveLocalObject(l.objectId,n.time)}).on("SkillCastNotify",n=>{let a=n.parsed;if(!a)return;let l=this.#a.getSourceEntity(a.caster);l=this.#a.guessIsPlayer(l,a.skillId),this.#s.onStartSkill(l,a.skillId,n.time)}).on("SkillDamageAbnormalMoveNotify",n=>{let a=n.parsed;if(!a)return;let l=this.#a.getSourceEntity(a.sourceId);a.skillDamageAbnormalMoveEvents.forEach(d=>{let m=this.#a.getOrCreateEntity(d.skillDamageEvent.targetId),h=this.#a.getOrCreateEntity(a.sourceId);m.stats.set(1,d.skillDamageEvent.curHp),m.stats.set(27,d.skillDamageEvent.maxHp),this.#s.onDamage(l,h,m,{skillId:a.skillId,skillEffectId:a.skillEffectId,damage:Number(d.skillDamageEvent.damage),modifier:d.skillDamageEvent.modifier,targetCurHp:Number(d.skillDamageEvent.curHp),targetMaxHp:Number(d.skillDamageEvent.maxHp),damageAttr:d.skillDamageEvent.damageAttr??0,damageType:d.skillDamageEvent.damageType},a.skillDamageAbnormalMoveEvents.length,n.time)})}).on("SkillDamageNotify",n=>{let a=n.parsed;if(!a)return;let l=this.#a.getSourceEntity(a.sourceId);a.skillDamageEvents.forEach(d=>{let m=this.#a.getOrCreateEntity(d.targetId),h=this.#a.getOrCreateEntity(a.sourceId);this.#s.onDamage(l,h,m,{skillId:a.skillId,skillEffectId:a.skillEffectId,damage:Number(d.damage),modifier:d.modifier,targetCurHp:Number(d.curHp),targetMaxHp:Number(d.maxHp),damageAttr:d.damageAttr??0,damageType:d.damageType},a.skillDamageEvents.length,n.time)})}).on("SkillStageNotify",n=>{}).on("SkillStartNotify",n=>{let a=n.parsed;if(!a)return;let l=this.#a.getSourceEntity(a.sourceId);if(l=this.#a.guessIsPlayer(l,a.skillId),l.entityType===1){let d=l,m=d.skills.get(a.skillId);if(m||(m={effects:new Set,tripods:new Map},d.skills.set(a.skillId,m)),m.level=a.skillLevel,a.skillOptionData.tripodIndex&&a.skillOptionData.tripodLevel){m.tripods||(m.tripods=new Map);for(let[h,v]of["first","second","third"].entries()){if(a.skillOptionData.tripodIndex[v]===0){for(let O=1;O<=3;O++)m.tripods.delete(3*h+O);continue}let c=3*h+a.skillOptionData.tripodIndex[v],E=a.skillOptionData.tripodLevel[v],A=m.tripods.get(c);if(A&&E===A.level)continue;for(let O=1;O<=3;O++)m.tripods.delete(3*h+O);let B=this.#e.skillFeature.get(a.skillId)?.get(c),C=[];B&&B.entries.forEach(O=>{O.level!==0&&O.level!==E||C.push(O)}),m.tripods.set(c,{level:a.skillOptionData.tripodLevel[v],options:C.sort((O,K)=>K.level-O.level)})}}}this.#s.onStartSkill(l,a.skillId,n.time)}).on("StatusEffectAddNotify",n=>{let a=n.parsed;if(!a)return;let l=this.#a.getSourceEntity(a.statusEffectData.sourceId);this.#i.RegisterStatusEffect(this.#i.buildStatusEffect(a.statusEffectData,a.objectId,l.entityId,1,n.time))}).on("StatusEffectDurationNotify",n=>{let a=n.parsed;a&&this.#i.UpdateDuration(a.effectInstanceId,a.targetId,a.expirationTick,1)}).on("StatusEffectRemoveNotify",n=>{let a=n.parsed;if(a)for(let l of a.statusEffectIds)this.#i.RemoveStatusEffect(a.objectId,l,1,a.reason,n.time)}).on("StatusEffectSyncDataNotify",n=>{let a=n.parsed;a&&this.#i.SyncStatusEffect(a.effectInstanceId,a.characterId,a.objectId,a.value,this.#a.localPlayer.characterId)}).on("TriggerBossBattleStatus",n=>{this.#s.onPhaseTransition(2,n.time)}).on("TriggerFinishNotify",n=>{}).on("TriggerStartNotify",n=>{let a=n.parsed;if(a)switch(a.triggerSignalType){case 57:case 59:case 61:case 63:case 74:case 76:this.#d=!0,this.#l=!1;break;case 58:case 60:case 62:case 64:case 75:case 77:this.#d=!1,this.#l=!0;break}}).on("TroopMemberUpdateMinNotify",n=>{}).on("ZoneObjectUnpublishNotify",n=>{let a=n.parsed;a&&this.#i.RemoveLocalObject(a.objectId,n.time)}).on("ZoneStatusEffectAddNotify",n=>{}).on("TroopMemberUpdateMinNotify",n=>{let a=n.parsed;if(a&&a.statusEffectDatas.length>0)for(let l of a.statusEffectDatas){let d=this.#r.getEntityId(a.characterId),m=l.value?l.value.readUInt32LE():0,h=l.value?l.value.readUInt32LE(8):0,v=m<h?m:h;this.#i.SyncStatusEffect(l.effectInstanceId,a.characterId,d,v,this.#a.localPlayer.characterId)}}).on("ZoneStatusEffectRemoveNotify",n=>{}),this.#i.on("shieldApplied",n=>{let a=n.targetId;if(n.type===0&&(a=this.#r.getEntityId(n.targetId)??a),a===void 0)return;let l=this.#a.getSourceEntity(n.sourceId),d=this.#a.getOrCreateEntity(a);this.#s.onShieldApplied(d,l,n.statusEffectId,n.value)}).on("shieldChanged",(n,a,l)=>{let d=n.targetId;if(n.type===0&&(d=this.#r.getEntityId(n.targetId)??d),d===void 0)return;let m=this.#a.getSourceEntity(n.sourceId),h=this.#a.getOrCreateEntity(d);this.#s.onShieldUsed(h,m,n.statusEffectId,a-l)})}broadcastStateChange(){this.emit("state-change",this.#s.getBroadcast())}reset(){this.#s.resetState(+new Date)}cancelReset(){this.#s.cancelReset()}updateOptions(r){this.#s.updateOptions(r)}get encounters(){return this.#s.splitEncounter(new Date),this.#s.encounters}};0&&(module.exports={Parser});
