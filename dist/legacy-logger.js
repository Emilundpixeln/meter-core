"use strict";var w=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var P=Object.prototype.hasOwnProperty;var q=(k,l)=>{for(var s in l)w(k,s,{get:l[s],enumerable:!0})},T=(k,l,s,a)=>{if(l&&typeof l=="object"||typeof l=="function")for(let n of N(l))!P.call(k,n)&&n!==s&&w(k,n,{get:()=>l[n],enumerable:!(a=S(l,n))||a.enumerable});return k};var E=k=>T(w({},"__esModule",{value:!0}),k);var e={};q(e,{LegacyLogger:()=>o,LineId:()=>x});module.exports=E(e);var I=require("tiny-typed-emitter");var x=(d=>(d[d.InitEnv=1]="InitEnv",d[d.PhaseTransition=2]="PhaseTransition",d[d.NewPC=3]="NewPC",d[d.NewNpc=4]="NewNpc",d[d.Death=5]="Death",d[d.SkillStart=6]="SkillStart",d[d.SkillStage=7]="SkillStage",d[d.Damage=8]="Damage",d[d.Heal=9]="Heal",d[d.Buff=10]="Buff",d[d.BuffRemove=11]="BuffRemove",d[d.CounterAttack=12]="CounterAttack",d[d.Line15=15]="Line15",d[d.Debug=251]="Debug",d[d.PacketDump=252]="PacketDump",d[d.Version=253]="Version",d[d.Error=254]="Error",d))(x||{}),o=class extends I.TypedEmitter{#l;emitText;emitLines;emitObjects;#p;#u;#h;#f;#s;constructor(l,s,a={}){super(),this.#l=s,this.emitText=a.emitText||!0,this.emitLines=a.emitLines||!0,this.emitObjects=a.emitObjects||!1,this.#p=new Set,this.#u=new v,this.#h=!1,this.#f=!1,this.#s={name:"You",class:0,gearLevel:0},l.on("PKTAuthTokenResult",n=>{}).on("PKTCounterAttackNotify",n=>{if(this.#n){let _=n.parsed;this.#_(12,_.SourceId,this.#d(_.SourceId),_.TargetId,this.#d(_.TargetId))}}).on("PKTDeathNotify",n=>{if(this.#n){let _=n.parsed;this.#_(5,_.TargetId,this.#d(_.TargetId),_.SourceId,this.#d(_.SourceId))}}).on("PKTInitEnv",n=>{let _=n.parsed;this.#u=new v;let u={entityId:_.PlayerId,entityType:b.Player,name:this.#s.name,class:this.#s.class,gearLevel:this.#s.gearLevel};this.#u.entities.set(u.entityId,u),this.#n&&this.#_(1,u.entityId)}).on("PKTInitPC",n=>{let _=n.parsed;this.#s={name:_.Name,class:_.ClassId,gearLevel:this.#b(_.GearLevel)};let u={entityId:_.PlayerId,entityType:b.Player,name:_.Name,class:_.ClassId,gearLevel:this.#b(_.GearLevel)};this.#u.entities.set(u.entityId,u);let f=this.#a(n.parsed.statPair);this.#n&&this.#_(3,u.entityId,u.name,u.class,this.#l.getClassName(u.class),_.Level,u.gearLevel,Number(f.get(1))||0,Number(f.get(27))||0)}).on("PKTNewNpc",n=>{let _=n.parsed,u={entityId:_.NpcStruct.ObjectId,entityType:b.Npc,name:this.#l.getNpcName(_.NpcStruct.TypeId),typeId:_.NpcStruct.TypeId};this.#u.entities.set(u.entityId,u);let f=this.#a(n.parsed.NpcStruct.statPair);this.#n&&this.#_(4,u.entityId,u.typeId,u.name,Number(f.get(1))||0,Number(f.get(27))||0)}).on("PKTNewNpcSummon",n=>{let _=n.parsed,u={entityId:_.NpcData.ObjectId,entityType:b.Summon,name:_.NpcData.ObjectId.toString(16),ownerId:_.OwnerId};this.#u.entities.set(u.entityId,u)}).on("PKTNewPC",n=>{let _=n.parsed,u={entityId:_.PCStruct.PlayerId,entityType:b.Player,name:_.PCStruct.Name,class:_.PCStruct.ClassId,gearLevel:this.#b(_.PCStruct.GearLevel)};this.#u.entities.set(u.entityId,u);let f=this.#a(n.parsed.PCStruct.statPair);this.#n&&this.#_(3,u.entityId,u.name,u.class,this.#l.getClassName(u.class),_.PCStruct.Level,u.gearLevel,Number(f.get(1))||0,Number(f.get(27))||0)}).on("PKTNewProjectile",n=>{let _=n.parsed,u={entityId:_.projectileInfo.ProjectileId,entityType:b.Projectile,name:_.projectileInfo.ProjectileId.toString(16),ownerId:_.projectileInfo.OwnerId};this.#u.entities.set(u.entityId,u)}).on("PKTParalyzationStateNotify",n=>{}).on("PKTPartyInfo",n=>{}).on("PKTPartyLeaveResult",n=>{}).on("PKTPartyStatusEffectAddNotify",n=>{}).on("PKTPartyStatusEffectRemoveNotify",n=>{}).on("PKTPartyStatusEffectResultNotify",n=>{}).on("PKTRaidBossKillNotify",n=>{this.#n&&this.#_(2,1)}).on("PKTRaidResult",n=>{this.#n&&this.#_(2,0)}).on("PKTRemoveObject",n=>{}).on("PKTSkillDamageAbnormalMoveNotify",n=>{if(this.#n){let _=n.parsed,u=this.#k(_.SourceId),f=this.#l.getSkillName(_.SkillId),p=this.#l.getSkillEffectComment(_.SkillEffectId);u=this.#v(u,_.SkillId),_.SkillDamageAbnormalMoveEvents.forEach(h=>{(h.skillDamageEvent.Modifier&15)===11&&_.SkillId===0&&_.SkillEffectId===0||(_.SkillId===0&&_.SkillEffectId===0&&h.skillDamageEvent.Modifier&12&&(f="Bleed"),this.#_(8,u.entityId,u.name,_.SkillId,f,_.SkillEffectId,p,h.skillDamageEvent.TargetId,this.#d(h.skillDamageEvent.TargetId),Number(h.skillDamageEvent.Damage),h.skillDamageEvent.Modifier,Number(h.skillDamageEvent.CurHp),Number(h.skillDamageEvent.MaxHp)))})}}).on("PKTSkillDamageNotify",n=>{if(this.#n){let _=n.parsed,u=this.#k(_.SourceId),f=this.#l.getSkillName(_.SkillId),p=this.#l.getSkillEffectComment(_.SkillEffectId);u=this.#v(u,_.SkillId),_.SkillDamageEvents.forEach(h=>{(h.Modifier&15)===11&&_.SkillId===0&&_.SkillEffectId===0||(_.SkillId===0&&_.SkillEffectId===0&&h.Modifier&12&&(f="Bleed"),this.#_(8,u.entityId,u.name,_.SkillId,f,_.SkillEffectId,p,h.TargetId,this.#d(h.TargetId),Number(h.Damage),h.Modifier,Number(h.CurHp),Number(h.MaxHp)))})}}).on("PKTSkillStageNotify",n=>{if(this.#n){let _=n.parsed;this.#_(7,_.SourceId,this.#d(_.SourceId),_.SkillId,this.#l.getSkillName(_.SkillId),_.Stage)}}).on("PKTSkillStartNotify",n=>{if(this.#n){let _=n.parsed;this.#_(6,_.SourceId,this.#d(_.SourceId),_.SkillId,this.#l.getSkillName(_.SkillId))}}).on("PKTStatChangeOriginNotify",n=>{if(this.#n){let _=n.parsed,u=this.#a(n.parsed.StatPairList),f=this.#a(n.parsed.Unk1);this.#_(9,_.ObjectId,this.#d(_.ObjectId),Number(f.get(1))||0,Number(u.get(1))||0)}}).on("PKTStatusEffectAddNotify",n=>{}).on("PKTStatusEffectRemoveNotify",n=>{}).on("PKTTriggerBossBattleStatus",n=>{this.#n&&this.#_(2,2)}).on("PKTTriggerFinishNotify",n=>{}).on("PKTTriggerStartNotify",n=>{switch(n.parsed.TriggerSignalType){case 57:case 59:case 61:case 63:case 74:case 76:this.#f=!0,this.#h=!1;break;case 58:case 60:case 62:case 64:case 75:case 77:this.#f=!1,this.#h=!0;break}})}#_(l,...s){if(this.emitText){let a=`${l}|${new Date().toISOString()}|${s.map(n=>typeof n=="bigint"?n.toString(16):n).join("|")}`;this.emit("line",a)}this.emitLines&&this.emit(l,...s)}get#n(){return this.emitText||this.emitLines}#k(l){let s=this.#u.entities.get(l);if((s?.entityType===b.Projectile||s?.entityType===b.Summon)&&(l=s.ownerId),s=this.#u.entities.get(l),!s){let a={entityId:l,entityType:b.Npc,name:l.toString(16)};return this.#u.entities.set(l,a),a}return s}#v(l,s){let a=this.#l.getSkillClassId(s);if(l.entityType!==b.Player&&a!==0){let n={entityId:l.entityId,entityType:b.Player,name:l.entityId.toString(16),class:a,gearLevel:0};return this.#u.entities.set(l.entityId,n),this.#_(3,n.entityId,n.name,n.class,this.#l.getClassName(n.class),1,n.gearLevel,0,0),n}return l}#d(l){return this.#u.entities.get(l)?.name||l.toString(16)}#a(l){let s=new Map;return l.forEach(a=>{s.set(a.Unk0_0_1,a.readNBytesInt64)}),s}#b(l){let s=Buffer.alloc(4);return s.writeUInt32LE(l),Math.round(s.readFloatLE()*100)/100}},v=class{start;entities;constructor(){this.start=Date.now(),this.entities=new Map}},b=(n=>(n[n.Player=0]="Player",n[n.Npc=1]="Npc",n[n.Summon=2]="Summon",n[n.Projectile=3]="Projectile",n))(b||{});0&&(module.exports={LegacyLogger,LineId});
