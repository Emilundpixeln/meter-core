"use strict";var p=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var P=Object.prototype.hasOwnProperty;var N=(b,l)=>{for(var s in l)p(b,s,{get:l[s],enumerable:!0})},q=(b,l,s,a)=>{if(l&&typeof l=="object"||typeof l=="function")for(let n of S(l))!P.call(b,n)&&n!==s&&p(b,n,{get:()=>l[n],enumerable:!(a=x(l,n))||a.enumerable});return b};var T=b=>q(p({},"__esModule",{value:!0}),b);var L={};N(L,{LegacyLogger:()=>w,LineId:()=>I});module.exports=T(L);var e=require("tiny-typed-emitter");var I=(d=>(d[d.InitEnv=1]="InitEnv",d[d.PhaseTransition=2]="PhaseTransition",d[d.NewPC=3]="NewPC",d[d.NewNpc=4]="NewNpc",d[d.Death=5]="Death",d[d.SkillStart=6]="SkillStart",d[d.SkillStage=7]="SkillStage",d[d.Damage=8]="Damage",d[d.Heal=9]="Heal",d[d.Buff=10]="Buff",d[d.BuffRemove=11]="BuffRemove",d[d.CounterAttack=12]="CounterAttack",d[d.Line15=15]="Line15",d[d.Debug=251]="Debug",d[d.PacketDump=252]="PacketDump",d[d.Version=253]="Version",d[d.Error=254]="Error",d))(I||{}),w=class extends e.TypedEmitter{#l;emitText;emitLines;emitObjects;#v;#u;#o;#b;#s;constructor(l,s,a={}){super(),this.#l=s,this.emitText=a.emitText||!0,this.emitLines=a.emitLines||!0,this.emitObjects=a.emitObjects||!1,this.#v=new Set,this.#u=new k,this.#o=!1,this.#b=!1,this.#s={name:"You",class:0,gearLevel:0},l.on("PKTAuthTokenResult",n=>{}).on("PKTCounterAttackNotify",n=>{try{if(this.#n){let _=n.parsed;this.#_(12,_.SourceId,this.#d(_.SourceId),_.TargetId,this.#d(_.TargetId))}}catch(_){console.error(`[meter-core/LegacyLogger] ${_}`)}}).on("PKTDeathNotify",n=>{try{if(this.#n){let _=n.parsed;this.#_(5,_.TargetId,this.#d(_.TargetId),_.SourceId,this.#d(_.SourceId))}}catch(_){console.error(`[meter-core/LegacyLogger] ${_}`)}}).on("PKTInitEnv",n=>{try{let _=n.parsed;this.#u=new k;let u={entityId:_.PlayerId,entityType:o.Player,name:this.#s.name,class:this.#s.class,gearLevel:this.#s.gearLevel};this.#u.entities.set(u.entityId,u),this.#n&&this.#_(1,u.entityId)}catch(_){console.error(`[meter-core/LegacyLogger] ${_}`)}}).on("PKTInitPC",n=>{try{let _=n.parsed;this.#s={name:_.Name,class:_.ClassId,gearLevel:this.#k(_.GearLevel)};let u={entityId:_.PlayerId,entityType:o.Player,name:_.Name,class:_.ClassId,gearLevel:this.#k(_.GearLevel)};if(this.#u.entities.set(u.entityId,u),this.#n){let f=this.#a(n.parsed.statPair);this.#_(3,u.entityId,u.name,u.class,this.#l.getClassName(u.class),_.Level,u.gearLevel,Number(f.get(1))||0,Number(f.get(27))||0)}}catch(_){console.error(`[meter-core/LegacyLogger] ${_}`)}}).on("PKTNewNpc",n=>{try{let _=n.parsed,u={entityId:_.NpcStruct.ObjectId,entityType:o.Npc,name:this.#l.getNpcName(_.NpcStruct.TypeId),typeId:_.NpcStruct.TypeId};if(this.#u.entities.set(u.entityId,u),this.#n){let f=this.#a(n.parsed.NpcStruct.statPair);this.#_(4,u.entityId,u.typeId,u.name,Number(f.get(1))||0,Number(f.get(27))||0)}}catch(_){console.error(`[meter-core/LegacyLogger] ${_}`)}}).on("PKTNewNpcSummon",n=>{try{let _=n.parsed,u={entityId:_.NpcData.ObjectId,entityType:o.Summon,name:_.NpcData.ObjectId.toString(16),ownerId:_.OwnerId};this.#u.entities.set(u.entityId,u)}catch(_){console.error(`[meter-core/LegacyLogger] ${_}`)}}).on("PKTNewPC",n=>{try{let _=n.parsed,u={entityId:_.PCStruct.PlayerId,entityType:o.Player,name:_.PCStruct.Name,class:_.PCStruct.ClassId,gearLevel:this.#k(_.PCStruct.GearLevel)};if(this.#u.entities.set(u.entityId,u),this.#n){let f=this.#a(n.parsed.PCStruct.statPair);this.#_(3,u.entityId,u.name,u.class,this.#l.getClassName(u.class),_.PCStruct.Level,u.gearLevel,Number(f.get(1))||0,Number(f.get(27))||0)}}catch(_){console.error(`[meter-core/LegacyLogger] ${_}`)}}).on("PKTNewProjectile",n=>{try{let _=n.parsed,u={entityId:_.projectileInfo.ProjectileId,entityType:o.Projectile,name:_.projectileInfo.ProjectileId.toString(16),ownerId:_.projectileInfo.OwnerId};this.#u.entities.set(u.entityId,u)}catch(_){console.error(`[meter-core/LegacyLogger] ${_}`)}}).on("PKTParalyzationStateNotify",n=>{}).on("PKTPartyInfo",n=>{}).on("PKTPartyLeaveResult",n=>{}).on("PKTPartyStatusEffectAddNotify",n=>{}).on("PKTPartyStatusEffectRemoveNotify",n=>{}).on("PKTPartyStatusEffectResultNotify",n=>{}).on("PKTRaidBossKillNotify",n=>{this.#n&&this.#_(2,1)}).on("PKTRaidResult",n=>{this.#n&&this.#_(2,0)}).on("PKTRemoveObject",n=>{}).on("PKTSkillDamageAbnormalMoveNotify",n=>{if(this.#n){let _=n.parsed,u=this.#h(_.SourceId),f=this.#l.getSkillName(_.SkillId),v=this.#l.getSkillEffectComment(_.SkillEffectId);u=this.#f(u,_.SkillId),_.SkillDamageAbnormalMoveEvents.forEach(h=>{(h.skillDamageEvent.Modifier&15)===11&&_.SkillId===0&&_.SkillEffectId===0||(_.SkillId===0&&_.SkillEffectId===0&&h.skillDamageEvent.Modifier&12&&(f="Bleed"),this.#_(8,u.entityId,u.name,_.SkillId,f,_.SkillEffectId,v,h.skillDamageEvent.TargetId,this.#d(h.skillDamageEvent.TargetId),Number(h.skillDamageEvent.Damage),h.skillDamageEvent.Modifier.toString(16),Number(h.skillDamageEvent.CurHp),Number(h.skillDamageEvent.MaxHp)))})}}).on("PKTSkillDamageNotify",n=>{try{if(this.#n){let _=n.parsed,u=this.#h(_.SourceId),f=this.#l.getSkillName(_.SkillId),v=this.#l.getSkillEffectComment(_.SkillEffectId);u=this.#f(u,_.SkillId),_.SkillDamageEvents.forEach(h=>{(h.Modifier&15)===11&&_.SkillId===0&&_.SkillEffectId===0||(_.SkillId===0&&_.SkillEffectId===0&&h.Modifier&12&&(f="Bleed"),this.#_(8,u.entityId,u.name,_.SkillId,f,_.SkillEffectId,v,h.TargetId,this.#d(h.TargetId),Number(h.Damage),h.Modifier.toString(16),Number(h.CurHp),Number(h.MaxHp)))})}}catch(_){console.error(`[meter-core/LegacyLogger] ${_}`)}}).on("PKTSkillStageNotify",n=>{try{if(this.#n){let _=n.parsed,u=this.#h(_.SourceId);u=this.#f(u,_.SkillId),this.#_(7,u.entityId,u.name,_.SkillId,this.#l.getSkillName(_.SkillId),_.Stage)}}catch(_){console.error(`[meter-core/LegacyLogger] ${_}`)}}).on("PKTSkillStartNotify",n=>{try{if(this.#n){let _=n.parsed,u=this.#h(_.SourceId);u=this.#f(u,_.SkillId),this.#_(6,u.entityId,u.name,_.SkillId,this.#l.getSkillName(_.SkillId))}}catch(_){console.error(`[meter-core/LegacyLogger] ${_}`)}}).on("PKTStatChangeOriginNotify",n=>{try{if(this.#n){let _=n.parsed,u=this.#a(n.parsed.StatPairList),f=this.#a(n.parsed.Unk1);this.#_(9,_.ObjectId,this.#d(_.ObjectId),Number(f.get(1))||0,Number(u.get(1))||0)}}catch(_){console.error(`[meter-core/LegacyLogger] ${_}`)}}).on("PKTStatusEffectAddNotify",n=>{}).on("PKTStatusEffectRemoveNotify",n=>{}).on("PKTTriggerBossBattleStatus",n=>{this.#n&&this.#_(2,2)}).on("PKTTriggerFinishNotify",n=>{}).on("PKTTriggerStartNotify",n=>{try{switch(n.parsed.TriggerSignalType){case 57:case 59:case 61:case 63:case 74:case 76:this.#b=!0,this.#o=!1;break;case 58:case 60:case 62:case 64:case 75:case 77:this.#b=!1,this.#o=!0;break}}catch(_){console.error(`[meter-core/LegacyLogger] ${_}`)}})}#_(l,...s){if(this.emitText){let a=`${l}|${new Date().toISOString()}|${s.map(n=>typeof n=="bigint"?n.toString(16):n).join("|")}`;this.emit("line",a)}this.emitLines&&this.emit(l,...s)}get#n(){return this.emitText||this.emitLines}#h(l){let s=this.#u.entities.get(l);if((s?.entityType===o.Projectile||s?.entityType===o.Summon)&&(l=s.ownerId),s=this.#u.entities.get(l),!s){let a={entityId:l,entityType:o.Npc,name:l.toString(16)};return this.#u.entities.set(l,a),a}return s}#f(l,s){let a=this.#l.getSkillClassId(s);if(a!==0){let n;if(l.entityType===o.Player){let _=l;if(_.class==a)return _;n={entityId:_.entityId,entityType:o.Player,name:_.name,class:a,gearLevel:_.gearLevel}}else n={entityId:l.entityId,entityType:o.Player,name:l.name,class:a,gearLevel:0};return this.#u.entities.set(l.entityId,n),this.#_(3,n.entityId,n.name,n.class,this.#l.getClassName(n.class),1,n.gearLevel,0,0),n}return l}#d(l){return this.#u.entities.get(l)?.name||l.toString(16)}#a(l){let s=new Map;return l.forEach(a=>{s.set(a.Unk0_0_1,a.readNBytesInt64)}),s}#k(l){let s=Buffer.alloc(4);return s.writeUInt32LE(l),Math.round(s.readFloatLE()*100)/100}},k=class{start;entities;constructor(){this.start=Date.now(),this.entities=new Map}},o=(n=>(n[n.Player=0]="Player",n[n.Npc=1]="Npc",n[n.Summon=2]="Summon",n[n.Projectile=3]="Projectile",n))(o||{});0&&(module.exports={LegacyLogger,LineId});
