"use strict";var w=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var P=Object.prototype.hasOwnProperty;var q=(v,l)=>{for(var s in l)w(v,s,{get:l[s],enumerable:!0})},T=(v,l,s,a)=>{if(l&&typeof l=="object"||typeof l=="function")for(let _ of N(l))!P.call(v,_)&&_!==s&&w(v,_,{get:()=>l[_],enumerable:!(a=S(l,_))||a.enumerable});return v};var E=v=>T(w({},"__esModule",{value:!0}),v);var L={};q(L,{LegacyLogger:()=>o,LineId:()=>x});module.exports=E(L);var I=require("tiny-typed-emitter");var x=(d=>(d[d.InitEnv=1]="InitEnv",d[d.PhaseTransition=2]="PhaseTransition",d[d.NewPC=3]="NewPC",d[d.NewNpc=4]="NewNpc",d[d.Death=5]="Death",d[d.SkillStart=6]="SkillStart",d[d.SkillStage=7]="SkillStage",d[d.Damage=8]="Damage",d[d.Heal=9]="Heal",d[d.Buff=10]="Buff",d[d.BuffRemove=11]="BuffRemove",d[d.CounterAttack=12]="CounterAttack",d[d.Line15=15]="Line15",d[d.Debug=251]="Debug",d[d.PacketDump=252]="PacketDump",d[d.Version=253]="Version",d[d.Error=254]="Error",d))(x||{}),o=class extends I.TypedEmitter{#l;emitText;emitLines;emitObjects;#p;#u;#b;#v;#s;constructor(l,s,a={}){super(),this.#l=s,this.emitText=a.emitText||!0,this.emitLines=a.emitLines||!0,this.emitObjects=a.emitObjects||!1,this.#p=new Set,this.#u=new k,this.#b=!1,this.#v=!1,this.#s={name:"You",class:0,gearLevel:0},l.on("PKTAuthTokenResult",_=>{}).on("PKTCounterAttackNotify",_=>{if(this.#n){let n=_.parsed;this.#_(12,n.SourceId,this.#d(n.SourceId),n.TargetId,this.#d(n.TargetId))}}).on("PKTDeathNotify",_=>{if(this.#n){let n=_.parsed;this.#_(5,n.TargetId,this.#d(n.TargetId),n.SourceId,this.#d(n.SourceId))}}).on("PKTInitEnv",_=>{let n=_.parsed;this.#u=new k;let u={entityId:n.PlayerId,entityType:b.Player,name:this.#s.name,class:this.#s.class,gearLevel:this.#s.gearLevel};this.#u.entities.set(u.entityId,u),this.#n&&this.#_(1,u.entityId)}).on("PKTInitPC",_=>{let n=_.parsed;this.#s={name:n.Name,class:n.ClassId,gearLevel:this.#k(n.GearLevel)};let u={entityId:n.PlayerId,entityType:b.Player,name:n.Name,class:n.ClassId,gearLevel:this.#k(n.GearLevel)};this.#u.entities.set(u.entityId,u);let f=this.#a(_.parsed.statPair);this.#n&&this.#_(3,u.entityId,u.name,u.class,this.#l.getClassName(u.class),n.Level,u.gearLevel,Number(f.get(1))||0,Number(f.get(27))||0)}).on("PKTNewNpc",_=>{let n=_.parsed,u={entityId:n.NpcStruct.ObjectId,entityType:b.Npc,name:this.#l.getNpcName(n.NpcStruct.TypeId),typeId:n.NpcStruct.TypeId};this.#u.entities.set(u.entityId,u);let f=this.#a(_.parsed.NpcStruct.statPair);this.#n&&this.#_(4,u.entityId,u.typeId,u.name,Number(f.get(1))||0,Number(f.get(27))||0)}).on("PKTNewNpcSummon",_=>{let n=_.parsed,u={entityId:n.NpcData.ObjectId,entityType:b.Summon,name:n.NpcData.ObjectId.toString(16),ownerId:n.OwnerId};this.#u.entities.set(u.entityId,u)}).on("PKTNewPC",_=>{let n=_.parsed,u={entityId:n.PCStruct.PlayerId,entityType:b.Player,name:n.PCStruct.Name,class:n.PCStruct.ClassId,gearLevel:this.#k(n.PCStruct.GearLevel)};this.#u.entities.set(u.entityId,u);let f=this.#a(_.parsed.PCStruct.statPair);this.#n&&this.#_(3,u.entityId,u.name,u.class,this.#l.getClassName(u.class),n.PCStruct.Level,u.gearLevel,Number(f.get(1))||0,Number(f.get(27))||0)}).on("PKTNewProjectile",_=>{let n=_.parsed,u={entityId:n.projectileInfo.ProjectileId,entityType:b.Projectile,name:n.projectileInfo.ProjectileId.toString(16),ownerId:n.projectileInfo.OwnerId};this.#u.entities.set(u.entityId,u)}).on("PKTParalyzationStateNotify",_=>{}).on("PKTPartyInfo",_=>{}).on("PKTPartyLeaveResult",_=>{}).on("PKTPartyStatusEffectAddNotify",_=>{}).on("PKTPartyStatusEffectRemoveNotify",_=>{}).on("PKTPartyStatusEffectResultNotify",_=>{}).on("PKTRaidBossKillNotify",_=>{this.#n&&this.#_(2,1)}).on("PKTRaidResult",_=>{this.#n&&this.#_(2,0)}).on("PKTRemoveObject",_=>{}).on("PKTSkillDamageAbnormalMoveNotify",_=>{if(this.#n){let n=_.parsed,u=this.#h(n.SourceId),f=this.#l.getSkillName(n.SkillId),p=this.#l.getSkillEffectComment(n.SkillEffectId);u=this.#f(u,n.SkillId),n.SkillDamageAbnormalMoveEvents.forEach(h=>{(h.skillDamageEvent.Modifier&15)===11&&n.SkillId==0,n.SkillEffectId!=0&&this.#_(8,u.entityId,u.name,n.SkillId,f,n.SkillEffectId,p,h.skillDamageEvent.TargetId,this.#d(h.skillDamageEvent.TargetId),Number(h.skillDamageEvent.Damage),h.skillDamageEvent.Modifier,Number(h.skillDamageEvent.CurHp),Number(h.skillDamageEvent.MaxHp))})}}).on("PKTSkillDamageNotify",_=>{if(this.#n){let n=_.parsed,u=this.#h(n.SourceId),f=this.#l.getSkillName(n.SkillId),p=this.#l.getSkillEffectComment(n.SkillEffectId);u=this.#f(u,n.SkillId),n.SkillDamageEvents.forEach(h=>{(h.Modifier&15)===11&&n.SkillId==0,n.SkillEffectId!=0&&this.#_(8,u.entityId,u.name,n.SkillId,f,n.SkillEffectId,p,h.TargetId,this.#d(h.TargetId),Number(h.Damage),h.Modifier,Number(h.CurHp),Number(h.MaxHp))})}}).on("PKTSkillStageNotify",_=>{if(this.#n){let n=_.parsed,u=this.#h(n.SourceId);u=this.#f(u,n.SkillId),this.#_(7,u.entityId,u.name,n.SkillId,this.#l.getSkillName(n.SkillId),n.Stage)}}).on("PKTSkillStartNotify",_=>{if(this.#n){let n=_.parsed,u=this.#h(n.SourceId);u=this.#f(u,n.SkillId),this.#_(6,u.entityId,u.name,n.SkillId,this.#l.getSkillName(n.SkillId))}}).on("PKTStatChangeOriginNotify",_=>{if(this.#n){let n=_.parsed,u=this.#a(_.parsed.StatPairList),f=this.#a(_.parsed.Unk1);this.#_(9,n.ObjectId,this.#d(n.ObjectId),Number(f.get(1))||0,Number(u.get(1))||0)}}).on("PKTStatusEffectAddNotify",_=>{}).on("PKTStatusEffectRemoveNotify",_=>{}).on("PKTTriggerBossBattleStatus",_=>{this.#n&&this.#_(2,2)}).on("PKTTriggerFinishNotify",_=>{}).on("PKTTriggerStartNotify",_=>{switch(_.parsed.TriggerSignalType){case 57:case 59:case 61:case 63:case 74:case 76:this.#v=!0,this.#b=!1;break;case 58:case 60:case 62:case 64:case 75:case 77:this.#v=!1,this.#b=!0;break}})}#_(l,...s){if(this.emitText){let a=`${l}|${new Date().toISOString()}|${s.map(_=>typeof _=="bigint"?_.toString(16):_).join("|")}`;this.emit("line",a)}this.emitLines&&this.emit(l,...s)}get#n(){return this.emitText||this.emitLines}#h(l){let s=this.#u.entities.get(l);if((s?.entityType===b.Projectile||s?.entityType===b.Summon)&&(l=s.ownerId),s=this.#u.entities.get(l),!s){let a={entityId:l,entityType:b.Npc,name:l.toString(16)};return this.#u.entities.set(l,a),a}return s}#f(l,s){let a=this.#l.getSkillClassId(s);if(l.entityType!==b.Player&&a!==0){let _={entityId:l.entityId,entityType:b.Player,name:l.entityId.toString(16),class:a,gearLevel:0};return this.#u.entities.set(l.entityId,_),this.#_(3,_.entityId,_.name,_.class,this.#l.getClassName(_.class),1,_.gearLevel,0,0),_}return l}#d(l){return this.#u.entities.get(l)?.name||l.toString(16)}#a(l){let s=new Map;return l.forEach(a=>{s.set(a.Unk0_0_1,a.readNBytesInt64)}),s}#k(l){let s=Buffer.alloc(4);return s.writeUInt32LE(l),Math.round(s.readFloatLE()*100)/100}},k=class{start;entities;constructor(){this.start=Date.now(),this.entities=new Map}},b=(_=>(_[_.Player=0]="Player",_[_.Npc=1]="Npc",_[_.Summon=2]="Summon",_[_.Projectile=3]="Projectile",_))(b||{});0&&(module.exports={LegacyLogger,LineId});
